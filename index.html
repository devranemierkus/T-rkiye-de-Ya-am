<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>TC Ya≈üam Sim√ºlasyonu V3.0</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 30px;
      box-sizing: border-box;
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    h1 {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 2.5em;
    }
    label {
      display: block;
      margin: 10px 0;
      font-size: 1.1rem;
      width: 100%;
      max-width: 400px;
      text-align: left;
    }
    input, select, textarea {
      display: block;
      margin-top: 5px;
      padding: 12px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #555;
      background: #333;
      color: #fff;
      border-radius: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 15px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: background-color 0.3s ease;
      max-width: 300px;
      width: 100%;
    }
    button:hover {
      background-color: #45a049;
    }
    canvas { display: block; }
    #info, #event-overlay, #military-info, #psychologist-overlay {
      position: absolute;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      font-size: 16px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,255,0,0.3);
      border: 1px solid #4CAF50;
      z-index: 11; /* Above UI for events */
    }
    #info {
      bottom: 20px;
      left: 20px;
      width: 300px;
    }
    #event-overlay, #psychologist-overlay {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      text-align: center;
      display: none; /* Hidden by default */
    }
    #event-overlay h2, #psychologist-overlay h2 {
      color: #FFEB3B;
      margin-top: 0;
    }
    #event-overlay p, #psychologist-overlay p {
      margin-bottom: 20px;
    }
    #event-overlay button, #psychologist-overlay button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1rem;
      max-width: unset;
      width: auto;
    }
    .option-button {
      background-color: #2196F3;
    }
    .option-button:hover {
      background-color: #1976D2;
    }
    #military-info {
      top: 20px;
      right: 20px;
      display: none; /* Hidden until military service starts */
    }
    #psychologist-input {
      width: calc(100% - 24px); /* Full width minus padding */
      margin-bottom: 15px;
      height: 100px;
      resize: vertical;
    }
    #game-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      z-index: 11;
      display: none; /* Hidden until game starts */
    }
    #game-controls button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 0.9rem;
      width: auto;
      max-width: unset;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    <h1>üçº TC Ya≈üam Sim√ºlasyonu üáπüá∑</h1>
    <label>Ad: <input id="name" placeholder="Adƒ±nƒ± gir"></label>
    <label>Soyad: <input id="surname" placeholder="Soyadƒ±nƒ± gir"></label>
    <label>Doƒüum Yƒ±lƒ±: <input type="number" id="year" value="2025"></label>
    <label>Hastalƒ±k (isteƒüe baƒülƒ±):
      <select id="disease">
        <option value="">Yok</option>
        <option value="k√∂r">G√∂rme Engeli</option>
        <option value="felc">Fel√ß</option>
        <option value="mide">Mide Sorunu</option>
      </select>
    </label>
    <label>Din Se√ß:
      <select id="religion">
        <option value="yok">Yok</option>
        <option value="islam">ƒ∞slam</option>
        <option value="hristiyan">Hristiyanlƒ±k</option>
        <option value="yahudi">Yahudilik</option>
        <option value="budist">Budizm</option>
      </select>
    </label>
    <button onclick="startLife()">Hayata Ba≈üla</button>
  </div>

  <div id="info"></div>
  <div id="event-overlay">
    <h2 id="event-title"></h2>
    <p id="event-message"></p>
    <div id="event-options"></div>
  </div>
  <div id="military-info">
    <p>≈ûafak Sayacƒ±: <span id="safak-counter"></span> g√ºn</p>
    <p>Askerlik Durumu: <span id="military-status"></span></p>
  </div>
  <div id="psychologist-overlay">
    <h2 id="psychologist-title">Psikolog Seansƒ±</h2>
    <p id="psychologist-message">Derdiƒüini yazarak anlatabilirsin. (Kalan k√ºf√ºr hakkƒ±n: <span id="curse-attempts"></span>)</p>
    <textarea id="psychologist-input" placeholder="Dertlerini buraya yaz..."></textarea>
    <div id="psychologist-response"></div>
    <button onclick="submitPsychologistInput()">G√∂nder</button>
    <button class="option-button" onclick="hidePsychologistOverlay()">Bitir</button>
  </div>

  <div id="game-controls">
    <button onclick="movePlayer('forward')">ƒ∞leri</button>
    <button onclick="movePlayer('back')">Geri</button>
    <button onclick="movePlayer('left')">Sol</button>
    <button onclick="movePlayer('right')">Saƒü</button>
    <button onclick="toggleWalkAnimation()">Y√ºr√º/Dur</button>
    <button onclick="toggleRunAnimation()">Ko≈ü/Dur</button>
  </div>


  <audio id="cry" src="https://www.soundjay.com/human/sounds/baby-crying-01.mp3"></audio>
  <audio id="voiceMom" src="https://www.soundjay.com/human/sounds/female-voice-01.mp3"></audio>
  <audio id="voiceDad" src="https://www.soundjay.com/human/sounds/male-voice-01.mp3"></audio>
  <audio id="explosion" src="https://www.soundjay.com/misc/sounds/explosion-01.mp3"></audio>
  <audio id="carHorn" src="https://www.soundjay.com/vehicles/sounds/car-horn-01.mp3"></audio>


  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    // --- Three.js Setup ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("gameCanvas"), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x87CEEB); // Sky blue background
    renderer.shadowMap.enabled = true; // Enable shadows
    renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows
    camera.position.set(0, 2, 8);

    // Lights
    const ambientLight = new THREE.AmbientLight(0x404040, 2);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
    directionalLight.position.set(5, 10, 7);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 1024;
    directionalLight.shadow.mapSize.height = 1024;
    directionalLight.shadow.camera.near = 0.5;
    directionalLight.shadow.camera.far = 50;
    directionalLight.shadow.camera.left = -10;
    directionalLight.shadow.camera.right = 10;
    directionalLight.shadow.camera.top = 10;
    directionalLight.shadow.camera.bottom = -10;
    scene.add(directionalLight);

    // Ground plane (Grass)
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(100, 100),
      new THREE.MeshStandardMaterial({ color: 0x558B2F, side: THREE.DoubleSide }) // Darker green
    );
    plane.rotation.x = Math.PI / 2;
    plane.receiveShadow = true;
    scene.add(plane);

    // GLTF Loader (for future complex models)
    const loader = new THREE.GLTFLoader();

    // Player and NPC Objects (initially placeholder, will be replaced by GLTF models)
    let playerObject, momObject, dadObject;
    let mixer; // For animation mixer
    const clock = new THREE.Clock();

    // Player Animation States
    let isWalking = false;
    let isRunning = false;

    // --- Scene Creation Functions (Updated to hint at GLTF loading) ---

    function createBirthScene() {
      // Clear all existing objects except lights and ground
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Simple baby model (Sphere for now, replace with GLTF)
      const baby = new THREE.Mesh(
        new THREE.SphereGeometry(0.4, 32, 32),
        new THREE.MeshStandardMaterial({ color: 0xffccaa, roughness: 0.7, metalness: 0.1 })
      );
      baby.position.y = 0.5;
      baby.name = "baby";
      scene.add(baby);

      const bed = new THREE.Mesh(
        new THREE.BoxGeometry(2, 0.2, 1),
        new THREE.MeshStandardMaterial({ color: 0x8b4513, roughness: 0.8 })
      );
      bed.position.y = 0;
      scene.add(bed);

      // Parent models (Sphere for now, replace with GLTF)
      momObject = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 32, 32),
        new THREE.MeshStandardMaterial({ color: 0xffaaaa, roughness: 0.7, metalness: 0.1 })
      );
      momObject.position.set(-1.5, 1.2, 0);
      momObject.name = "mom";
      scene.add(momObject);

      dadObject = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 32, 32),
        new THREE.MeshStandardMaterial({ color: 0xaaaaff, roughness: 0.7, metalness: 0.1 })
      );
      dadObject.position.set(1.5, 1.2, 0);
      dadObject.name = "dad";
      scene.add(dadObject);

      currentEnvironment = "birth";
      camera.position.set(0, 1.6, 5); // Closer view for birth
    }

    function createHomeScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Room elements - more defined walls and floor
      const wallsMaterial = new THREE.MeshStandardMaterial({ color: 0xAAAAAA, side: THREE.BackSide, roughness: 0.8 });
      const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 }); // Wooden floor
      const ceilingMaterial = new THREE.MeshStandardMaterial({ color: 0xEEEEEE });

      const roomSize = 12;
      const wallHeight = 4;

      const floor = new THREE.Mesh(new THREE.BoxGeometry(roomSize, 0.1, roomSize), floorMaterial);
      floor.position.y = -0.05;
      scene.add(floor);

      const ceiling = new THREE.Mesh(new THREE.BoxGeometry(roomSize, 0.1, roomSize), ceilingMaterial);
      ceiling.position.y = wallHeight - 0.05;
      scene.add(ceiling);

      // Walls
      const wall1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, wallHeight, roomSize), wallsMaterial);
      wall1.position.set(-roomSize / 2, wallHeight / 2 - 0.05, 0);
      scene.add(wall1);
      const wall2 = new THREE.Mesh(new THREE.BoxGeometry(0.1, wallHeight, roomSize), wallsMaterial);
      wall2.position.set(roomSize / 2, wallHeight / 2 - 0.05, 0);
      scene.add(wall2);
      const wall3 = new THREE.Mesh(new THREE.BoxGeometry(roomSize, wallHeight, 0.1), wallsMaterial);
      wall3.position.set(0, wallHeight / 2 - 0.05, -roomSize / 2);
      scene.add(wall3);
      const wall4 = new THREE.Mesh(new THREE.BoxGeometry(roomSize, wallHeight, 0.1), wallsMaterial);
      wall4.position.set(0, wallHeight / 2 - 0.05, roomSize / 2);
      scene.add(wall4);

      // Placeholder for player (replace with actual human model)
      if (!playerObject) {
        playerObject = new THREE.Mesh(
          new THREE.CapsuleGeometry(0.4, 1.0, 32, 32),
          new THREE.MeshStandardMaterial({ color: 0xffffcc, roughness: 0.6 })
        );
        playerObject.castShadow = true;
      }
      playerObject.position.set(0, 0.8, 0);
      scene.add(playerObject);

      // Placeholder for parents (will need to load GLTF models)
      if (!momObject) {
        momObject = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.0, 32, 32), new THREE.MeshStandardMaterial({ color: 0xffaaaa }));
        momObject.castShadow = true;
      }
      momObject.position.set(-3, 0.8, -3);
      scene.add(momObject);

      if (!dadObject) {
        dadObject = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.0, 32, 32), new THREE.MeshStandardMaterial({ color: 0xaaaaff }));
        dadObject.castShadow = true;
      }
      dadObject.position.set(3, 0.8, -3);
      scene.add(dadObject);


      // Simple furniture
      const table = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.7, 0.8), new THREE.MeshStandardMaterial({ color: 0x552200 }));
      table.position.set(2, 0.35, -2);
      scene.add(table);
      const chair = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.5), new THREE.MeshStandardMaterial({ color: 0x774411 }));
      chair.position.set(2, 0.4, -1.5);
      scene.add(chair);

      currentEnvironment = "home";
      camera.position.set(0, 2, 5); // Adjust camera for home view
    }

    // New scene for school, dynamically changes based on age
    function createSchoolScene(grade) {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // School Building (placeholder)
      const schoolBuilding = new THREE.Mesh(
        new THREE.BoxGeometry(15, 8, 10),
        new THREE.MeshStandardMaterial({ color: 0xB0C4DE }) // Light blue-grey
      );
      schoolBuilding.position.y = 4;
      schoolBuilding.position.z = -5;
      scene.add(schoolBuilding);

      // Classroom elements (placeholder)
      const blackboard = new THREE.Mesh(
        new THREE.BoxGeometry(4, 2, 0.1),
        new THREE.MeshStandardMaterial({ color: 0x000000 })
      );
      blackboard.position.set(0, 2.5, 4.9);
      scene.add(blackboard);

      const teacherDesk = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 0.8, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
      );
      teacherDesk.position.set(0, 0.4, 3);
      scene.add(teacherDesk);

      // Desks and chairs
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 3; j++) {
          const studentDesk = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 0.6, 0.6),
            new THREE.MeshStandardMaterial({ color: 0x552200 })
          );
          studentDesk.position.set(i * 2 - 3, 0.3, j * 1.5 - 2);
          scene.add(studentDesk);

          const studentChair = new THREE.Mesh(
            new THREE.BoxGeometry(0.4, 0.7, 0.4),
            new THREE.MeshStandardMaterial({ color: 0x774411 })
          );
          studentChair.position.set(i * 2 - 3, 0.35, j * 1.5 - 2 + 0.5);
          scene.add(studentChair);
        }
      }

      if (playerObject) {
        playerObject.position.set(-2, 0.8, 0); // Player in classroom
      }
      scene.add(playerObject);

      // Update appearance based on grade (conceptual - would involve changing textures/models)
      if (grade === "ilkokul") {
        // Smaller desks, brighter colors etc.
      } else if (grade === "ortaokul") {
        // Slightly larger desks
      } else if (grade === "lise") {
        // Adult-like desks
      } else if (grade === "√ºniversite") {
        // Lecture hall setup
      }

      currentEnvironment = "school";
      camera.position.set(0, 4, 10); // View from back of classroom
    }


    function createMilitaryScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Barracks/Training Ground feel
      const barracksWall = new THREE.Mesh(
        new THREE.BoxGeometry(10, 3, 0.5),
        new THREE.MeshStandardMaterial({ color: 0x666666 })
      );
      barracksWall.position.set(0, 1.5, -4);
      scene.add(barracksWall);

      const tent = new THREE.Mesh(
        new THREE.ConeGeometry(1.5, 2, 4),
        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
      );
      tent.position.set(3, 1, 0);
      scene.add(tent);

      if (playerObject) {
        playerObject.position.set(-2, 0.8, 2);
        // Player appearance for military (uniform - conceptual)
      }
      scene.add(playerObject);

      currentEnvironment = "military";
      camera.position.set(0, 4, 10);
    }

    function createCityScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Simple buildings
      const buildingMaterial = new THREE.MeshStandardMaterial({ color: 0x999999 });
      for (let i = 0; i < 7; i++) {
        const height = Math.random() * 8 + 4;
        const building = new THREE.Mesh(
          new THREE.BoxGeometry(Math.random() * 3 + 1, height, Math.random() * 3 + 1),
          buildingMaterial
        );
        building.position.set(Math.random() * 20 - 10, height / 2, Math.random() * 20 - 10);
        building.castShadow = true;
        scene.add(building);
      }

      // Road
      const road = new THREE.Mesh(
        new THREE.BoxGeometry(40, 0.05, 10),
        new THREE.MeshStandardMaterial({ color: 0x444444 })
      );
      road.position.z = -5;
      scene.add(road);

      // Sidewalks
      const sidewalkMaterial = new THREE.MeshStandardMaterial({ color: 0x777777 });
      const sidewalk1 = new THREE.Mesh(new THREE.BoxGeometry(40, 0.1, 2), sidewalkMaterial);
      sidewalk1.position.set(0, 0.05, 0);
      scene.add(sidewalk1);
      const sidewalk2 = new THREE.Mesh(new THREE.BoxGeometry(40, 0.1, 2), sidewalkMaterial);
      sidewalk2.position.set(0, 0.05, -10);
      scene.add(sidewalk2);

      if (playerObject) {
        playerObject.position.set(0, 0.8, 5); // Player on sidewalk
        // Update player appearance for adult/city life (clothes - conceptual)
      }
      scene.add(playerObject);

      currentEnvironment = "city";
      camera.position.set(0, 5, 15); // Wider view for city
    }

    function createShopScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      const shopFloor = new THREE.Mesh(
        new THREE.BoxGeometry(10, 0.1, 10),
        new THREE.MeshStandardMaterial({ color: 0xD3D3D3 }) // Light grey
      );
      shopFloor.position.y = -0.05;
      scene.add(shopFloor);

      const counter = new THREE.Mesh(
        new THREE.BoxGeometry(3, 1, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
      );
      counter.position.set(0, 0.5, -4);
      scene.add(counter);

      const shelves = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 2.5, 5),
        new THREE.MeshStandardMaterial({ color: 0xA9A9A9 })
      );
      shelves.position.set(4.5, 1.25, 0);
      scene.add(shelves);

      if (playerObject) {
        playerObject.position.set(0, 0.8, 4);
      }
      scene.add(playerObject);
      currentEnvironment = "shop";
      camera.position.set(0, 2, 5);
    }

    function createHospitalScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      const hospitalFloor = new THREE.Mesh(
        new THREE.BoxGeometry(15, 0.1, 15),
        new THREE.MeshStandardMaterial({ color: 0xF5F5DC }) // Off-white
      );
      hospitalFloor.position.y = -0.05;
      scene.add(hospitalFloor);

      const bed = new THREE.Mesh(
        new THREE.BoxGeometry(2, 0.5, 1),
        new THREE.MeshStandardMaterial({ color: 0x808080 })
      );
      bed.position.set(-3, 0.25, 0);
      scene.add(bed);

      const doctorDesk = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 0.8, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x2F4F4F })
      );
      doctorDesk.position.set(3, 0.4, 0);
      scene.add(doctorDesk);

      if (playerObject) {
        playerObject.position.set(0, 0.8, 5);
      }
      scene.add(playerObject);
      currentEnvironment = "hospital";
      camera.position.set(0, 2, 5);
    }

    function createHalƒ±sahaScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      const field = new THREE.Mesh(
        new THREE.BoxGeometry(20, 0.1, 10),
        new THREE.MeshStandardMaterial({ color: 0x006400 }) // Dark green
      );
      field.position.y = -0.05;
      scene.add(field);

      const goal1 = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 2, 4),
        new THREE.MeshStandardMaterial({ color: 0xFFFFFF })
      );
      goal1.position.set(-9.5, 1, 0);
      scene.add(goal1);

      const goal2 = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 2, 4),
        new THREE.MeshStandardMaterial({ color: 0xFFFFFF })
      );
      goal2.position.set(9.5, 1, 0);
      scene.add(goal2);

      if (playerObject) {
        playerObject.position.set(0, 0.8, 0);
      }
      scene.add(playerObject);
      currentEnvironment = "halƒ±saha";
      camera.position.set(0, 5, 15);
    }

    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();
      if (mixer) mixer.update(delta); // Update animations

      // Joystick-like movement
      if (playerObject && (isWalking || isRunning)) {
        let speed = isWalking ? 0.05 : 0.1;
        // Basic forward movement relative to player's facing direction
        playerObject.position.x += Math.sin(playerObject.rotation.y) * speed;
        playerObject.position.z += Math.cos(playerObject.rotation.y) * speed;
      }

      // Basic animations based on current scene
      if (currentEnvironment === "birth") {
        const baby = scene.getObjectByName("baby");
        if (baby) baby.rotation.y += 0.01;
        if (momObject) momObject.rotation.y += 0.005;
        if (dadObject) dadObject.rotation.y -= 0.005;
      } else if (playerObject) {
        // Player animation handled by joystick controls
      }
      renderer.render(scene, camera);
    }
    animate();

    // --- Game Logic ---
    const info = document.getElementById("info");
    const eventOverlay = document.getElementById("event-overlay");
    const eventTitle = document.getElementById("event-title");
    const eventMessage = document.getElementById("event-message");
    const eventOptions = document.getElementById("event-options");
    const militaryInfoDiv = document.getElementById("military-info");
    const safakCounterSpan = document.getElementById("safak-counter");
    const militaryStatusSpan = document.getElementById("military-status");
    const psychologistOverlay = document.getElementById("psychologist-overlay");
    const psychologistInput = document.getElementById("psychologist-input");
    const psychologistResponseDiv = document.getElementById("psychologist-response");
    const curseAttemptsSpan = document.getElementById("curse-attempts");
    const gameControls = document.getElementById("game-controls");

    let player = {
      name: "",
      surname: "",
      year: 2025,
      age: 0,
      money: 0,
      disease: "",
      religion: "",
      family: Math.random() < 0.5 ? "Zengin" : "Fakir",
      karma: 0, // Amel Defteri
      hasCar: false,
      hasHouse: false,
      isMarried: false,
      militaryStatus: "Muaf Deƒüil",
      militaryServiceRemaining: 0,
      militaryDraftAttempts: 0,
      educationLevel: "Okul √ñncesi", // ƒ∞lkokul, Ortaokul, Lise, √úniversite, Mezun
      job: "ƒ∞≈üsiz",
      psychologicalHealth: 100, // Max 100, lower is worse
      curseCount: 0,
      psychologistBanUntil: 0 // Year when ban lifts
    };

    let ageInterval;
    let militaryInterval;
    const utterance = new SpeechSynthesisUtterance();
    utterance.lang = 'tr-TR'; // Turkish language for speech synthesis

    // Other NPCs (conceptual, will need their own models/data)
    let siblings = [];
    let friends = [];

    // --- Core Game Functions ---

    function startLife() {
      player.name = document.getElementById("name").value || "ƒ∞simsiz";
      player.surname = document.getElementById("surname").value || "Soyadsƒ±z";
      player.year = parseInt(document.getElementById("year").value) || 2025;
      player.disease = document.getElementById("disease").value;
      player.religion = document.getElementById("religion").value;

      document.getElementById("cry").play();
      document.getElementById("ui").style.display = "none";
      gameControls.style.display = "block"; // Show joystick controls

      if (player.disease === "k√∂r") {
        renderer.setClearColor(0x000000);
      } else {
        createBirthScene();
      }

      speakText("Ho≈ü geldin bebeƒüim! Ben annen.", document.getElementById("voiceMom"));
      setTimeout(() => {
        speakText("Hayata g√∂zlerini a√ßtƒ±n evlat! Ben de baban.", document.getElementById("voiceDad"));
      }, 4000);

      setTimeout(() => {
        spawnAtHome();
      }, 6000);
    }

    function speakText(text, audioElem = null) {
      if (audioElem) {
        audioElem.play();
      }
      utterance.text = text;
      speechSynthesis.speak(utterance);
    }

    function spawnAtHome() {
      createHomeScene();
      player.age = 0;
      updateInfo();

      // Create siblings with a chance
      if (Math.random() < 0.6) { // 60% chance to have a sibling
        const siblingGender = Math.random() < 0.5 ? "Erkek" : "Kƒ±z";
        const siblingName = siblingGender === "Erkek" ? "Ali" : "Ay≈üe"; // Simple names for now
        siblings.push({ name: siblingName, gender: siblingGender, age: 0 });
        speakText(`Bir de ${siblingName} adƒ±nda karde≈üin oldu!`, document.getElementById("voiceMom"));
      }


      ageInterval = setInterval(() => {
        player.age++;
        updateInfo();
        updatePlayerAppearance(); // Update player model based on age
        handleLifeEvents();
      }, 5000); // Each 5 seconds is 1 year
    }

    function updatePlayerAppearance() {
      // This is where you would load different GLTF models or apply texture changes
      // based on player.age to simulate growth, puberty, clothes etc.
      if (!playerObject) return; // Ensure player object exists

      if (player.age < 6) {
        // Baby/Toddler look (smaller, rounder)
        playerObject.scale.set(0.6, 0.6, 0.6);
      } else if (player.age >= 6 && player.age < 12) {
        // Child look
        playerObject.scale.set(0.8, 0.8, 0.8);
        player.educationLevel = "ƒ∞lkokul";
      } else if (player.age >= 12 && player.age < 18) {
        // Teenager look
        playerObject.scale.set(1, 1, 1); // Normal size
        player.educationLevel = "Ortaokul";
        handlePubertyChanges();
      } else if (player.age >= 18 && player.age < 22) {
        player.educationLevel = "Lise";
      } else if (player.age >= 22 && player.age < 26) {
        player.educationLevel = "√úniversite";
      } else if (player.age >= 26) {
        player.educationLevel = "Mezun";
      }

      // Clothes/hair color could change based on money, age etc.
      // Example: playerObject.material.color.set(new THREE.Color(0xRRGGBB));
      // For more complex visuals, load GLTF models:
      /*
      loader.load('path/to/aged_player_model.gltf', (gltf) => {
          if (playerObject) scene.remove(playerObject);
          playerObject = gltf.scene;
          playerObject.position.set(0, 0.8, 0); // Or current position
          playerObject.castShadow = true;
          scene.add(playerObject);
          mixer = new THREE.AnimationMixer(playerObject);
          // Load animations
      });
      */
    }

    function handlePubertyChanges() {
      // This is conceptual. Visually, you'd apply textures/materials for acne, body hair.
      if (player.age === 13 && !player.hasPubertyAcne) {
        showEvent("Ergenlik Belirtileri", "Y√ºz√ºnde sivilceler √ßƒ±kmaya ba≈üladƒ±! Ne yapacaksƒ±n?", [
          { text: "Sivilceleri patlat (Riskli)", action: () => {
              if (Math.random() < 0.5) {
                showEvent("Patlattƒ±n!", "Sivilce izleri kaldƒ± ve psikolojik saƒülƒ±ƒüƒ±n d√º≈üt√º.", [{ text: "Of!", action: () => { player.psychologicalHealth -= 5; } }]);
              } else {
                showEvent("Temizledin!", "Y√ºz√ºn biraz daha temiz g√∂r√ºn√ºyor.", [{ text: "ƒ∞yi", action: () => { player.karma += 1; } }]);
              }
              player.hasPubertyAcne = true;
            }
          },
          { text: "Bakƒ±m yap (50‚Ç∫)", action: () => {
              if (player.money >= 50) {
                player.money -= 50;
                showEvent("Bakƒ±m Yaptƒ±n!", "Sivilcelerin azaldƒ±, psikolojik saƒülƒ±ƒüƒ±n arttƒ±.", [{ text: "Te≈üekk√ºrler", action: () => { player.psychologicalHealth += 5; player.hasPubertyAcne = true; } }]);
              } else {
                showEvent("Paran Yok", "Bakƒ±m i√ßin yeterli paran yok!", [{ text: "Pekala", action: () => { } }]);
              }
            }
          },
          { text: "Umursama", action: () => { showEvent("Devam et", "Sivilcelerin kaldƒ±.", [{ text: "Neyse", action: () => { player.hasPubertyAcne = true; } }]); } }
        ]);
      }
      if (player.age === 14 && !player.hasBodyHair) {
        showEvent("Kƒ±llanma", "V√ºcudunda kƒ±llanma ba≈üladƒ±. Ne yapacaksƒ±n?", [
          { text: "Tƒ±ra≈ü et/al", action: () => { showEvent("Bakƒ±m", "V√ºcudunu temizledin.", [{ text: "Ferahlƒ±k!", action: () => { player.hasBodyHair = true; } }]); } },
          { text: "Doƒüal bƒ±rak", action: () => { showEvent("Olduƒüu gibi", "Doƒüal halini benimsedin.", [{ text: "Tamamdƒ±r", action: () => { player.hasBodyHair = true; } }]); } }
        ]);
      }
    }


    function updateInfo() {
      info.innerHTML = `
        **${player.name} ${player.surname}**
        Ya≈ü: ${player.age} (${player.educationLevel})
        Din: ${player.religion}
        Aile: ${player.family}
        Para: ${player.money}‚Ç∫
        Karma: ${player.karma}
        Psikolojik Saƒülƒ±k: ${player.psychologicalHealth}/100
        ƒ∞≈ü: ${player.job}
        Ev: ${player.hasHouse ? "Var" : "Yok"}
        Araba: ${player.hasCar ? "Var" : "Yok"}
        Evlilik: ${player.isMarried ? "Evli" : "Bekar"}
        Askerlik: ${player.militaryStatus}
        Karde≈üler: ${siblings.length > 0 ? siblings.map(s => s.name).join(', ') : "Yok"}
      `;
    }

    function showEvent(title, message, options) {
      eventTitle.innerText = title;
      eventMessage.innerText = message;
      eventOptions.innerHTML = "";
      options.forEach(option => {
        const button = document.createElement("button");
        button.innerText = option.text;
        button.className = "option-button";
        button.onclick = () => {
          hideEvent();
          option.action();
        };
        eventOptions.appendChild(button);
      });
      eventOverlay.style.display = "flex";
      speakText(`${title}. ${message}`); // Speak event message
    }

    function hideEvent() {
      eventOverlay.style.display = "none";
    }

    function handleLifeEvents() {
      // --- Childhood & Education ---
      if (player.age === 6) {
        showEvent("Okula Ba≈ülama", "ƒ∞lkokula ba≈ülƒ±yorsun! Okula gitmek ister misin?", [
          { text: "Evet, okula git", action: () => { createSchoolScene("ilkokul"); player.karma += 5; } },
          { text: "Hayƒ±r, gitmek istemiyorum", action: () => { player.karma -= 10; speakText("Okula gitmeyi reddettin. Bu kararƒ±n ileriki hayatƒ±nƒ± etkileyebilir."); } }
        ]);
      } else if (player.age === 10 && player.educationLevel === "ƒ∞lkokul" && Math.random() < 0.2) { // Random school question
        showEvent("Okulda Soru", "√ñƒüretmen sana bir soru sordu: 'T√ºrkiye'nin ba≈ükenti neresidir?'", [
          { text: "Ankara", action: () => { showEvent("Doƒüru Cevap!", "√ñƒüretmen seni tebrik etti.", [{ text: "Te≈üekk√ºrler", action: () => { player.karma += 2; } }]); } },
          { text: "ƒ∞stanbul", action: () => { showEvent("Yanlƒ±≈ü Cevap!", "√ñƒüretmen sana √ºz√ºld√º.", [{ text: "√úzg√ºn√ºm", action: () => { player.karma -= 1; } }]); } }
        ]);
      } else if (player.age === 14 && player.educationLevel === "Ortaokul") {
        showEvent("Ortaokul Bitiyor", "Lise i√ßin hangi alana y√∂nelmek istersin?", [
          { text: "Fen Lisesi (Zeka)", action: () => { player.karma += 5; } },
          { text: "Sosyal Bilimler Lisesi (Sosyal)", action: () => { player.karma += 3; } },
          { text: "Meslek Lisesi (Pratik)", action: () => { player.karma += 2; } }
        ]);
      } else if (player.age === 18 && player.educationLevel === "Lise") {
        showEvent("Lise Bitti!", "√úniversiteye gitmek ister misin? (Sƒ±nav var!)", [
          { text: "Evet, sƒ±nava gir", action: () => { takeUniversityExam(); } },
          { text: "Hayƒ±r, direkt i≈ü hayatƒ±na atƒ±l", action: () => { player.job = "Niteliksiz ƒ∞≈ü√ßi"; player.money += 500; speakText("√úniversiteye gitmeyi tercih etmedin. ƒ∞≈ü hayatƒ±na atƒ±ldƒ±n."); } }
        ]);
      }

      // --- Adulthood & Career ---
      if (player.age === 20 && player.militaryStatus === "Muaf Deƒüil" && player.militaryDraftAttempts < 3) {
        askForMilitaryService();
      } else if (player.age === 25 && !player.isMarried) {
        showEvent("Evlilik Zamanƒ±?", "Evlilik d√º≈ü√ºnceleri aklƒ±na gelmeye ba≈üladƒ±. Birini bulabilecek misin?", [
          { text: "Evet, birini ara", action: () => { attemptMarriage(); } },
          { text: "Hen√ºz deƒüil, kariyer √∂nceliƒüim", action: () => { player.money += 1000; } }
        ]);
      } else if (player.age === 26 && player.job === "ƒ∞≈üsiz" && player.educationLevel === "Mezun") {
        showEvent("Meslek Se√ßimi", "Hangi mesleƒüi yapmak istersin?", [
          { text: "Yazƒ±lƒ±mcƒ± (Y√ºksek Gelir)", action: () => { player.job = "Yazƒ±lƒ±mcƒ±"; player.money += 5000; speakText("Yazƒ±lƒ±mcƒ± oldun!"); createCityScene(); } },
          { text: "√ñƒüretmen (Orta Gelir)", action: () => { player.job = "√ñƒüretmen"; player.money += 2500; speakText("√ñƒüretmen oldun!"); createCityScene(); } },
          { text: "Esnaf (Deƒüi≈üken Gelir)", action: () => { player.job = "Esnaf"; player.money += 1500; speakText("Esnaf oldun!"); createCityScene(); } }
        ]);
      } else if (player.age === 30 && !player.hasHouse) {
        showEvent("Ev Alma Zamanƒ±?", "Bir ev satƒ±n almak ister misin? (50.000‚Ç∫)", [
          { text: "Evet, al", action: () => { buyHouse(); } },
          { text: "Hayƒ±r, kirada kal", action: () => { player.money -= 100; speakText("Kirada kalmayƒ± tercih ettin."); } }
        ]);
      } else if (player.age === 35 && !player.hasCar) {
        showEvent("Araba Alma Zamanƒ±?", "Bir araba almak ister misin? (20.000‚Ç∫)", [
          { text: "Evet, al", action: () => { buyCar(); } },
          { text: "Hayƒ±r, toplu ta≈üƒ±ma kullan", action: () => { speakText("Toplu ta≈üƒ±ma kullanmayƒ± tercih ettin."); } }
        ]);
      }

      // --- Social & Random Events ---
      if (player.age >= 18 && Math.random() < 0.05 && friends.length === 0) { // Chance to make friends after 18
        showEvent("Yeni Arkada≈ü", "Yeni bir arkada≈ü edinmek ister misin?", [
          { text: "Evet", action: () => { friends.push("Can"); showEvent("Arkada≈ülƒ±k", "Can adƒ±nda yeni bir arkada≈üƒ±n oldu!", [{ text: "Harika!", action: () => { } }]); } },
          { text: "Hayƒ±r", action: () => { } }
        ]);
      } else if (player.age >= 18 && friends.length > 0 && Math.random() < 0.1) {
        showEvent("Halƒ±saha Ma√ßƒ±", "Arkada≈ülarƒ±nla halƒ± sahaya gitmek ister misin? (50‚Ç∫)", [
          { text: "Evet, git", action: () => { goToHalƒ±saha(); } },
          { text: "Hayƒ±r", action: () => { } }
        ]);
      }

      // Random psychological health events
      if (Math.random() < 0.08) { // 8% chance of psychological issue
        if (player.psychologicalHealth > 30) {
          showEvent("Psikolojik Destek", "Moralin bozuk ve kendini k√∂t√º hissediyorsun. Psikologdan yardƒ±m almak ister misin?", [
            { text: "Evet, git (200‚Ç∫)", action: () => { goToPsychologist(); } },
            { text: "Hayƒ±r, tek ba≈üƒ±ma atlatƒ±rƒ±m", action: () => { player.psychologicalHealth -= 10; speakText("Psikolojik saƒülƒ±ƒüƒ±n k√∂t√ºle≈üti."); } }
          ]);
        }
      }

      // General random events
      if (Math.random() < 0.1 && player.age >= 18) {
        handleRandomEvent();
      }

      // --- End Game ---
      if (player.age >= 80) {
        showEvent("Son Yƒ±llar", "Hayatƒ±nƒ±n son demlerindesin. Geride ne bƒ±rakacaksƒ±n?", [
          { text: "Hayata veda et...", action: () => { endGame(); } }
        ]);
      }
    }

    // --- Education Related Functions ---
    function takeUniversityExam() {
      hideEvent();
      showEvent("√úniversite Sƒ±navƒ±", "≈ûimdi √ºniversite sƒ±navƒ±na gireceksin. Sorularƒ± cevapla!", [
        { text: "Ba≈üla", action: () => { startUniversityExam(); } }
      ]);
    }

    let examScore = 0;
    let examAttempts = 0;
    let cheatAttempted = false;

    function startUniversityExam() {
      examScore = 0;
      cheatAttempted = false;
      if (player.psychologistBanUntil > player.year + player.age) {
          showEvent("Sƒ±nav Yasaƒüƒ±!", `Psikologdan atƒ±ldƒ±ƒüƒ±n i√ßin ${player.psychologistBanUntil} yƒ±lƒ±na kadar sƒ±nava giremezsin!`, [
              { text: "Pekala", action: () => {} }
          ]);
          return;
      }

      const questions = [
        { q: "T√ºrkiye'nin en y√ºksek daƒüƒ± hangisidir?", a: ["Aƒürƒ± Daƒüƒ±", "Erciyes", "Uludaƒü", "Ka√ßkar"], correct: 0 },
        { q: "Fotosentez nedir?", a: ["Bitkilerin nefes almasƒ±", "Bitkilerin besin √ºretmesi", "Bitkilerin su i√ßmesi", "Bitkilerin b√ºy√ºmesi"], correct: 1 },
        { q: "Kimya biliminin sembol√º H2O neyi temsil eder?", a: ["Karbonmonoksit", "Hidrojen peroksit", "Su", "Oksijen"], correct: 2 },
        { q: "Mustafa Kemal Atat√ºrk hangi yƒ±lda doƒümu≈ütur?", a: ["1880", "1881", "1882", "1883"], correct: 1 },
      ];

      let currentQuestionIndex = 0;

      function askQuestion() {
        if (currentQuestionIndex < questions.length) {
          const q = questions[currentQuestionIndex];
          const options = q.a.map((ans, idx) => ({
            text: ans,
            action: () => {
              if (idx === q.correct) {
                examScore += 25; // Each question is 25 points
                showEvent("Doƒüru!", `Puanƒ±n: ${examScore}`, [{ text: "Devam", action: () => { currentQuestionIndex++; askQuestion(); } }]);
              } else {
                showEvent("Yanlƒ±≈ü!", `Puanƒ±n: ${examScore}`, [{ text: "Devam", action: () => { currentQuestionIndex++; askQuestion(); } }]);
              }
            }
          }));

          options.push({ text: "Kopya √áek (Riskli)", action: () => { attemptCheat(); } });

          showEvent(`Sƒ±nav Sorusu ${currentQuestionIndex + 1}`, q.q, options);
        } else {
          finishExam();
        }
      }

      function attemptCheat() {
        if (Math.random() < 0.4) { // 40% chance of getting caught
          showEvent("Kopya √áekerken Yakalandƒ±n!", "Sƒ±navƒ±n iptal edildi! 1 ila 3 yƒ±l arasƒ± sƒ±nava giremeyeceksin.", [
            { text: "Eyvah!", action: () => {
                cheatAttempted = true;
                const banYears = Math.floor(Math.random() * 3) + 1; // 1 to 3 years ban
                player.psychologistBanUntil = player.year + player.age + banYears; // Using this property for exam ban
                finishExam(); // End exam prematurely
              }
            }
          ]);
        } else {
          examScore += 50; // Big boost for successful cheat
          showEvent("Kopya Ba≈üarƒ±lƒ±!", "Kimse g√∂rmedi. Puanƒ±n arttƒ±!", [
            { text: "≈ûanslƒ±yƒ±m!", action: () => { currentQuestionIndex++; askQuestion(); } }
          ]);
        }
      }

      function finishExam() {
        if (cheatAttempted) {
          showEvent("Sƒ±nav Sonucu", `Kopya nedeniyle sƒ±navƒ±n iptal edildi. ${player.psychologistBanUntil - (player.year + player.age)} yƒ±l sƒ±nava giremezsin.`, [
            { text: "Pekala", action: () => { player.educationLevel = "Lise Mezunu"; } }
          ]);
          speakText(`Kopya nedeniyle sƒ±navƒ±n iptal edildi.`);
          return;
        }

        if (examScore >= 60) {
          showEvent("Sƒ±navƒ± Ge√ßtin!", `Tebrikler! ${examScore} puanla √ºniversiteyi kazandƒ±n.`, [
            { text: "Ya≈üasƒ±n!", action: () => { player.educationLevel = "√úniversite √ñƒürencisi"; player.money -= 500; speakText("√úniversiteye kayƒ±t oldun."); createSchoolScene("√ºniversite"); } }
          ]);
        } else {
          showEvent("Sƒ±navƒ± Ge√ßemedin", `Maalesef ${examScore} puanla sƒ±navƒ± ge√ßemedin.`, [
            { text: "Tekrar deneyeceƒüim", action: () => { player.educationLevel = "Lise Mezunu"; } }
          ]);
          speakText(`Sƒ±navƒ± ge√ßemedin.`);
        }
      }

      askQuestion();
    }


    // --- Military Related Functions ---
    function askForMilitaryService() {
      player.militaryDraftAttempts++;
      showEvent("Askerlik √áaƒürƒ±sƒ±", "20 ya≈üƒ±na geldin ve askerlik √ßaƒürƒ±n geldi. Ne yapmak istersin?", [
        { text: "Askerliƒüe git (Normal)", action: () => { startMilitaryService("normal"); } },
        { text: "Bedelli yap (180.000‚Ç∫)", action: () => { startMilitaryService("bedelli"); } },
        { text: "≈ûimdilik gitme (5 yƒ±l sonra tekrar sorulacak)", action: () => { speakText("Askerliƒüi erteledin."); } }
      ]);

      if (player.militaryDraftAttempts >= 3 && player.militaryStatus === "Muaf Deƒüil") {
        showEvent("Zorunlu Askerlik!", "√áok fazla ka√ßtƒ±n! Artƒ±k zorla askere alƒ±nƒ±yorsun.", [
          { text: "Tamamdƒ±r...", action: () => { startMilitaryService("normal"); speakText("Zorla askere alƒ±ndƒ±n."); } }
        ]);
      }
    }

    function startMilitaryService(type) {
      clearInterval(ageInterval);
      createMilitaryScene();
      militaryInfoDiv.style.display = "block";

      if (type === "normal") {
        player.militaryStatus = "Askere Gitti";
        player.militaryServiceRemaining = 365;
        showEvent("Askerlik Ba≈üladƒ±!", "Kƒ±≈ülaya katƒ±ldƒ±n. Yeni hayatƒ±na ho≈ü geldin!", [
          { text: "G√∂rev bilinciyle...", action: () => { player.karma += 10; speakText("Askerlik g√∂revine ba≈üladƒ±n."); } }
        ]);
        militaryInterval = setInterval(updateMilitaryService, 1000);
      } else if (type === "bedelli") {
        if (player.money >= 180000) {
          player.money -= 180000;
          player.militaryStatus = "Bedelli Yaptƒ±";
          player.militaryServiceRemaining = 21;
          showEvent("Bedelli Yaptƒ±n!", "Paralƒ± askerlik hizmetini tamamladƒ±n. Hayatƒ±na devam edebilirsin.", [
            { text: "Oh be!", action: () => { speakText("Bedelli askerliƒüi tamamladƒ±n."); } }
          ]);
          militaryInterval = setInterval(updateMilitaryService, 500);
        } else {
          showEvent("Yetersiz Para", "Bedelli askerlik i√ßin yeterli paran yok! Normal askerlik veya erteleme se√ßmelisin.", [
            { text: "Anladƒ±m", action: () => { askForMilitaryService(); speakText("Yeterli paran yok."); } }
          ]);
          player.militaryStatus = "Muaf Deƒüil";
          ageInterval = setInterval(() => {
            player.age++;
            updateInfo();
            handleLifeEvents();
          }, 5000);
        }
      }
    }

    function updateMilitaryService() {
      player.militaryServiceRemaining--;
      safakCounterSpan.innerText = player.militaryServiceRemaining;
      militaryStatusSpan.innerText = player.militaryStatus;

      if (player.militaryServiceRemaining <= 0) {
        clearInterval(militaryInterval);
        militaryInfoDiv.style.display = "none";
        player.militaryStatus = "Terhis";
        showEvent("Terhis!", "Askerliƒüin bitti! Sivil hayata geri d√∂n√ºyorsun.", [
          { text: "Hayƒ±rlƒ± teskereler!", action: () => { createCityScene(); speakText("Askerliƒüin sona erdi."); } }
        ]);
        ageInterval = setInterval(() => {
          player.age++;
          updateInfo();
          handleLifeEvents();
        }, 5000);
      } else if (player.militaryStatus === "Askere Gitti") {
        if (player.militaryServiceRemaining % 30 === 0) {
          const randomEvent = Math.random();
          if (randomEvent < 0.3) {
            showEvent("Askerlik Olayƒ±", "Patates soyma g√∂revi aldƒ±n.", [
              { text: "Soy", action: () => { player.karma += 1; speakText("Patates soyma g√∂revi tamamlandƒ±."); } },
              { text: "ƒ∞tiraz et", action: () => { player.karma -= 5; showEvent("Ceza!", "Komutan ceza verdi.", [{ text: "T√ºh", action: () => { speakText("Komutan ceza verdi."); } }]); } }
            ]);
          } else if (randomEvent < 0.6) {
            showEvent("Askerlik Olayƒ±", "Sava≈üa katƒ±lmak zorunda kaldƒ±n!", [
              { text: "Cesurca sava≈ü", action: () => { player.karma += 15; showEvent("Kahramanlƒ±k!", "Takdir edildin.", [{ text: "Te≈üekk√ºrler", action: () => { speakText("Sava≈üta kahramanlƒ±k g√∂sterdin."); } }]); } },
              { text: "Saklan", action: () => { player.karma -= 10; showEvent("Korkaklƒ±k!", "Ceza aldƒ±n.", [{ text: "Eyvah", action: () => { speakText("Sava≈üta saklandƒ±n ve ceza aldƒ±n."); } }]); } }
            ]);
            document.getElementById("explosion").play();
          } else if (randomEvent < 0.8) {
            showEvent("Firar ≈ûansƒ±", "Firar etmek ister misin? √áok riskli!", [
              { text: "Firar et", action: () => { attemptDesertion(); speakText("Firar etmeyi deniyorsun."); } },
              { text: "Kƒ±≈ülada kal", action: () => { speakText("Kƒ±≈ülada kalmayƒ± tercih ettin."); } }
            ]);
          }
        }
      }
      updateInfo();
    }

    function attemptDesertion() {
      clearInterval(militaryInterval);
      militaryInfoDiv.style.display = "none";
      player.militaryStatus = "Firari";
      createCityScene();
      showEvent("Firar Ettin!", "Kƒ±≈üladan ka√ßtƒ±n! Polis seni arayacak...", [
        { text: "Saklanmaya √ßalƒ±≈ü", action: () => { player.karma -= 20; handleDesertionChase(); speakText("Firar ettin, ≈üimdi saklanmalƒ±sƒ±n."); } }
      ]);
      document.getElementById("carHorn").play();
    }

    function handleDesertionChase() {
      let chaseAttempts = 0;
      const chaseInterval = setInterval(() => {
        chaseAttempts++;
        if (chaseAttempts > 5) {
          clearInterval(chaseInterval);
          if (Math.random() < 0.7) {
            showEvent("Yakalandƒ±n!", "Polis seni yakaladƒ± ve askere geri g√∂t√ºr√ºyor!", [
              { text: "Lanet olsun", action: () => { startMilitaryService("normal"); player.militaryServiceRemaining += 180; player.karma -= 50; speakText("Yakalandƒ±n ve askerliƒüe geri d√∂nd√ºn."); } }
            ]);
          } else {
            showEvent("Ka√ßmayƒ± Ba≈üardƒ±n!", "Polisten ka√ßmayƒ± ba≈üardƒ±n! Artƒ±k √∂zg√ºrs√ºn ama firarisin.", [
              { text: "Yeni bir hayata ba≈üla", action: () => { speakText("Polisten ka√ßmayƒ± ba≈üardƒ±n."); } }
            ]);
            player.militaryStatus = "Firari (Ba≈üarƒ±lƒ±)";
            ageInterval = setInterval(() => {
              player.age++;
              updateInfo();
              handleLifeEvents();
            }, 5000);
          }
        } else {
          showEvent("Ka√ßƒ±≈ü Devam Ediyor...", `Polis seni aramaya devam ediyor. (${5 - chaseAttempts} deneme kaldƒ±)`, [
            { text: "K√∂≈üeye gizlen", action: () => { } },
            { text: "Kƒ±lƒ±k deƒüi≈ütir", action: () => { } }
          ]);
        }
      }, 5000);
    }

    // --- Relationship & Social Functions ---
    function attemptMarriage() {
      const partnerChance = Math.random();
      if (partnerChance < 0.6) {
        player.isMarried = true;
        showEvent("Evlendin!", "Hayat arkada≈üƒ±nƒ± buldun ve evlendiniz! Mutluluklar dileriz.", [
          { text: "√áok mutluyum!", action: () => { player.karma += 20; speakText("Evlendin!"); } }
        ]);
      } else {
        showEvent("Evlenemedin", "Uygun birini bulamadƒ±n veya evlilik kƒ±smetin olmadƒ±. Tekrar dene?", [
          { text: "≈ûansƒ±mƒ± denerim", action: () => { } },
          { text: "Yalnƒ±z kalacaƒüƒ±m", action: () => { player.karma -= 5; speakText("Evlenemedin."); } }
        ]);
      }
    }

    function goToHalƒ±saha() {
      if (player.money >= 50) {
        player.money -= 50;
        createHalƒ±sahaScene();
        showEvent("Halƒ±saha Ma√ßƒ±", "Arkada≈ülarƒ±nla harika bir ma√ß yaptƒ±n!", [
          { text: "√áok eƒülendim!", action: () => { player.psychologicalHealth += 10; player.karma += 3; speakText("Halƒ±saha ma√ßƒ± yaptƒ±n."); createCityScene(); } }
        ]);
      } else {
        showEvent("Yetersiz Para", "Halƒ±saha i√ßin yeterli paran yok!", [
          { text: "Pekala", action: () => { } }
        ]);
        speakText("Halƒ±saha i√ßin yeterli paran yok.");
      }
    }

    // --- Asset Functions ---
    function buyHouse() {
      if (player.money >= 50000) {
        player.money -= 50000;
        player.hasHouse = true;
        showEvent("Ev Aldƒ±n!", "Kendi evine sahip oldun! Artƒ±k kira derdin yok.", [
          { text: "Harika!", action: () => { player.karma += 10; speakText("Ev satƒ±n aldƒ±n!"); createHomeScene(); } }
        ]);
      } else {
        showEvent("Yetersiz Para", "Ev almak i√ßin yeterli paran yok! (50.000‚Ç∫)", [
          { text: "Daha √ßok √ßalƒ±≈ümalƒ±yƒ±m", action: () => { speakText("Ev almak i√ßin yeterli paran yok."); } }
        ]);
      }
    }

    function buyCar() {
      if (player.money >= 20000) {
        player.money -= 20000;
        player.hasCar = true;
        showEvent("Araba Aldƒ±n!", "Kendi araban var! Ula≈üƒ±m artƒ±k √ßok daha kolay.", [
          { text: "Yola √ßƒ±kalƒ±m!", action: () => { player.karma += 5; speakText("Araba satƒ±n aldƒ±n!"); } }
        ]);
      } else {
        showEvent("Yetersiz Para", "Araba almak i√ßin yeterli paran yok! (20.000‚Ç∫)", [
          { text: "Daha √ßok para biriktir", action: () => { speakText("Araba almak i√ßin yeterli paran yok."); } }
        ]);
      }
    }

    // --- Crime Functions ---
    function handleRandomEvent() {
      const eventType = Math.random();

      if (eventType < 0.2) {
        showEvent("≈ûanslƒ± G√ºn!", "Yolda para buldun!", [
          { text: "Al", action: () => { player.money += 100; player.karma += 1; speakText("Yolda para buldun."); } },
          { text: "Karakola teslim et", action: () => { showEvent("D√ºr√ºstl√ºk!", "√áok d√ºr√ºst davrandƒ±n. Karma puanƒ±n arttƒ±!", [{ text: "G√∂rev tamam", action: () => { player.karma += 10; speakText("Parayƒ± karakola teslim ettin."); } }]); } }
        ]);
      } else if (eventType < 0.4) {
        showEvent("K√∂t√º Bir G√ºn", "Cebindeki paranƒ± √ßaldƒ±rdƒ±n!", [
          { text: "Lanet olsun!", action: () => { player.money = Math.max(0, player.money - 500); player.karma -= 2; speakText("Paran √ßalƒ±ndƒ±!"); } }
        ]);
      } else if (eventType < 0.6) {
        showEvent("Ahlaki ƒ∞kilem", "Bir arkada≈üƒ±n senden yasa dƒ±≈üƒ± bir i≈üe katƒ±lmanƒ± istiyor.", [
          { text: "Kabul et (Riskli ama kazan√ßlƒ±)", action: () => { attemptCrime(); speakText("Yasa dƒ±≈üƒ± i≈ü teklifini kabul ettin."); } },
          { text: "Reddet (G√ºvenli)", action: () => { player.karma += 5; showEvent("D√ºr√ºstl√ºk", "Arkada≈üƒ±nƒ± reddettin, doƒüru olanƒ± yaptƒ±n.", [{ text: "ƒ∞yi insan", action: () => { speakText("Yasa dƒ±≈üƒ± i≈üi reddettin."); } }]); } }
        ]);
      } else {
        showEvent("Sƒ±radan Bir G√ºn", "Yeni bir hobiye ba≈ülamak ister misin?", [
          { text: "Evet (100‚Ç∫)", action: () => { if (player.money >= 100) { player.money -= 100; player.karma += 3; speakText("Yeni bir hobiye ba≈üladƒ±n."); } else { showEvent("Yetersiz Para", "Yeterli paran yok!", [{text: "Pekala", action: () => {}}]); } } },
          { text: "Hayƒ±r", action: () => { } }
        ]);
      }
    }

    function attemptCrime() {
      const crimeType = Math.random();
      if (crimeType < 0.5) {
        showEvent("Banka Soygunu Planƒ±!", "Bir banka soygununa katƒ±lmak ister misin? Yakalanƒ±rsan hapishane...", [
          { text: "Evet, soy", action: () => { executeBankRobbery(); speakText("Banka soygunu planlƒ±yorsun."); } },
          { text: "Hayƒ±r, √ßok riskli", action: () => { player.karma += 1; } }
        ]);
      } else {
        showEvent("Araba √áalma Fƒ±rsatƒ±!", "Park edilmi≈ü l√ºks bir araba g√∂rd√ºn. √áalmak ister misin?", [
          { text: "Evet, √ßal", action: () => { executeCarTheft(); speakText("Araba √ßalmayƒ± deniyorsun."); } },
          { text: "Hayƒ±r, ba≈üƒ±m belaya girmesin", action: () => { player.karma += 1; } }
        ]);
      }
    }

    function executeBankRobbery() {
      const successChance = Math.random();
      if (successChance < 0.3) {
        const loot = Math.floor(Math.random() * 5000) + 1000;
        player.money += loot;
        player.karma -= 50;
        showEvent("Soygun Ba≈üarƒ±lƒ±!", `Bankayƒ± soydun ve ${loot}‚Ç∫ kazandƒ±n!`, [
          { text: "Zengin oldum!", action: () => { speakText(`Banka soygunu ba≈üarƒ±lƒ±, ${loot} lira kazandƒ±n.`); } }
        ]);
        document.getElementById("explosion").play();
      } else {
        player.karma -= 100;
        showEvent("Yakalandƒ±n!", "Banka soygununda yakalandƒ±n! Hapse giriyorsun.", [
          { text: "Hapishaneye git", action: () => { goToPrison(5); speakText("Banka soygununda yakalandƒ±n, hapse giriyorsun."); } }
        ]);
      }
    }

    function executeCarTheft() {
      const successChance = Math.random();
      if (successChance < 0.6) {
        player.hasCar = true;
        player.money += 500;
        player.karma -= 20;
        showEvent("Araba √áalƒ±ndƒ±!", "Araba senin oldu! Satabilir veya kullanabilirsin.", [
          { text: "S√ºper!", action: () => { speakText("Araba √ßalma ba≈üarƒ±lƒ±!"); } }
        ]);
        document.getElementById("carHorn").play();
      } else {
        player.karma -= 40;
        showEvent("Yakalandƒ±n!", "Araba √ßalarken yakalandƒ±n! Hapse giriyorsun.", [
          { text: "Hapishaneye git", action: () => { goToPrison(2); speakText("Araba √ßalarken yakalandƒ±n, hapse giriyorsun."); } }
        ]);
      }
    }

    function goToPrison(years) {
      clearInterval(ageInterval);
      showEvent("Hapishane!", `Hapishaneye girdin. ${years} yƒ±l hapis yatacaksƒ±n.`, [
        { text: "Zor zamanlar...", action: () => { speakText(`Hapishaneye girdin, ${years} yƒ±l hapis yatacaksƒ±n.`); } }
      ]);
      const prisonSentenceInterval = setInterval(() => {
        years--;
        showEvent("Hapishane...", `Hapishanede ${years} yƒ±lƒ±n kaldƒ±.`, [
          { text: "Bekle...", action: () => { } }
        ]);
        if (years <= 0) {
          clearInterval(prisonSentenceInterval);
          showEvent("√ñzg√ºrl√ºk!", "Hapisten √ßƒ±ktƒ±n! Yeni bir ba≈ülangƒ±√ß yapabilirsin.", [
            { text: "Hayata geri d√∂n", action: () => { speakText("Hapisten √ßƒ±ktƒ±n, √∂zg√ºrs√ºn!"); } }
          ]);
          ageInterval = setInterval(() => {
            player.age++;
            updateInfo();
            handleLifeEvents();
          }, 5000);
        }
      }, 5000);
    }

    // --- Psychologist Functions ---
    function goToPsychologist() {
      if (player.psychologistBanUntil > player.year + player.age) {
        showEvent("Psikolog Yasaƒüƒ±", `K√ºf√ºr ettiƒüin i√ßin ${player.psychologistBanUntil} yƒ±lƒ±na kadar psikologdan yardƒ±m alamazsƒ±n.`, [
          { text: "Anladƒ±m", action: () => { } }
        ]);
        return;
      }
      if (player.money >= 200) {
        player.money -= 200;
        player.curseCount = 0; // Reset curse count for new session
        curseAttemptsSpan.innerText = 5; // Display max attempts
        psychologistInput.value = "";
        psychologistResponseDiv.innerText = "";
        psychologistOverlay.style.display = "flex";
        speakText("Merhaba, size nasƒ±l yardƒ±mcƒ± olabilirim? Dertlerinizi yazarak anlatabilirsiniz.", null);
        createHospitalScene(); // Set scene to hospital
      } else {
        showEvent("Yetersiz Para", "Psikolog √ºcreti i√ßin yeterli paran yok! (200‚Ç∫)", [
          { text: "Pekala", action: () => { } }
        ]);
      }
    }

    function submitPsychologistInput() {
      const userText = psychologistInput.value.toLowerCase();
      const forbiddenWords = ["lan", "salak", "aptal", "mal", "geri zekalƒ±", "pi√ß", "siktir", "orospu", "yarak", "amk", "aq", "sg"];
      let hasCurse = false;

      for (const word of forbiddenWords) {
        if (userText.includes(word)) {
          hasCurse = true;
          break;
        }
      }

      if (hasCurse) {
        player.curseCount++;
        curseAttemptsSpan.innerText = 5 - player.curseCount;
        if (player.curseCount >= 5) {
          psychologistResponseDiv.innerText = "Yeter! Seni artƒ±k kabul edemem. 7 ay boyunca gelme!";
          speakText("Yeter! Seni artƒ±k kabul edemem. 7 ay boyunca gelme!");
          player.psychologistBanUntil = player.year + player.age + (7 / 12); // Add 7 months to current age
          setTimeout(() => { hidePsychologistOverlay(); createCityScene(); }, 2000);
        } else {
          psychologistResponseDiv.innerText = `L√ºtfen k√ºf√ºr etmeyiniz. (${5 - player.curseCount} hakkƒ±nƒ±z kaldƒ±.)`;
          speakText("L√ºtfen k√ºf√ºr etmeyiniz.");
        }
      } else {
        // Simple response based on keywords
        if (userText.includes("mutsuzum") || userText.includes("depresyon")) {
          psychologistResponseDiv.innerText = "Anlƒ±yorum, bu zor bir durum. Daha iyi hissetmen i√ßin sana yardƒ±mcƒ± olacaƒüƒ±m. K√º√ß√ºk adƒ±mlarla ba≈ülayabiliriz.";
          player.psychologicalHealth += 10;
          speakText("Anlƒ±yorum, bu zor bir durum. Daha iyi hissetmen i√ßin sana yardƒ±mcƒ± olacaƒüƒ±m. K√º√ß√ºk adƒ±mlarla ba≈ülayabiliriz.");
        } else if (userText.includes("stres") || userText.includes("kaygƒ±")) {
          psychologistResponseDiv.innerText = "Stres ve kaygƒ± ya≈üamƒ±n bir par√ßasƒ± olabilir, ancak bunlarla ba≈üa √ßƒ±kma y√∂ntemleri geli≈ütirebiliriz.";
          player.psychologicalHealth += 5;
          speakText("Stres ve kaygƒ± ya≈üamƒ±n bir par√ßasƒ± olabilir, ancak bunlarla ba≈üa √ßƒ±kma y√∂ntemleri geli≈ütirebiliriz.");
        } else if (userText.includes("arkada≈ü")) {
            psychologistResponseDiv.innerText = "Arkada≈ülƒ±k ili≈ükileri √∂nemlidir. Onlarla baƒülarƒ±nƒ± g√º√ßlendirmek i√ßin neler yapabilirsin?";
            speakText("Arkada≈ülƒ±k ili≈ükileri √∂nemlidir. Onlarla baƒülarƒ±nƒ± g√º√ßlendirmek i√ßin neler yapabilirsin?");
        } else if (userText.includes("i≈ü")) {
            psychologistResponseDiv.innerText = "ƒ∞≈ü hayatƒ±ndaki zorluklar moralini bozmu≈ü olabilir. Bu konuda ne gibi adƒ±mlar atabiliriz?";
            speakText("ƒ∞≈ü hayatƒ±ndaki zorluklar moralini bozmu≈ü olabilir. Bu konuda ne gibi adƒ±mlar atabiliriz?");
        }
        else {
          psychologistResponseDiv.innerText = "Anlƒ±yorum. Biraz daha a√ßmak ister misin?";
          speakText("Anlƒ±yorum. Biraz daha a√ßmak ister misin?");
        }
        player.psychologicalHealth = Math.min(100, player.psychologicalHealth); // Max 100
      }
    }

    function hidePsychologistOverlay() {
      psychologistOverlay.style.display = "none";
      createCityScene(); // Return to city scene
    }


    // --- Game Controls (Joystick-like) ---
    function movePlayer(direction) {
      const rotationSpeed = 0.05;
      const moveSpeed = 0.1; // This is a base speed, actual speed depends on walk/run state

      if (!playerObject) return;

      switch (direction) {
        case 'forward':
          playerObject.position.x += Math.sin(playerObject.rotation.y) * moveSpeed;
          playerObject.position.z += Math.cos(playerObject.rotation.y) * moveSpeed;
          break;
        case 'back':
          playerObject.position.x -= Math.sin(playerObject.rotation.y) * moveSpeed;
          playerObject.position.z -= Math.cos(playerObject.rotation.y) * moveSpeed;
          break;
        case 'left':
          playerObject.rotation.y += rotationSpeed;
          break;
        case 'right':
          playerObject.rotation.y -= rotationSpeed;
          break;
      }
    }

    function toggleWalkAnimation() {
      isWalking = !isWalking;
      isRunning = false; // Cannot walk and run at same time
      // Here you would trigger walk animation clip in your GLTF model
      // if (mixer) {
      //   const walkClip = mixer.clipAction(playerObject.animations.find(a => a.name === 'walk'));
      //   if (isWalking) { walkClip.play(); } else { walkClip.stop(); }
      // }
    }

    function toggleRunAnimation() {
      isRunning = !isRunning;
      isWalking = false; // Cannot walk and run at same time
      // Here you would trigger run animation clip in your GLTF model
      // if (mixer) {
      //   const runClip = mixer.clipAction(playerObject.animations.find(a => a.name === 'run'));
      //   if (isRunning) { runClip.play(); } else { runClip.stop(); }
      // }
    }

    function endGame() {
      clearInterval(ageInterval);
      if (militaryInterval) clearInterval(militaryInterval);
      hideEvent();
      psychologistOverlay.style.display = 'none';
      document.getElementById("ui").style.display = "flex";
      document.getElementById("ui").innerHTML = `
        <h1>Hayat Yolculuƒüunun Sonu</h1>
        <p>**${player.name} ${player.surname}**, ${player.age} ya≈üƒ±nda hayatƒ±nƒ± kaybetti.</p>
        <p>Hayatƒ±nda topladƒ±ƒüƒ±n **Karma puanƒ±**: ${player.karma}</p>
        <p>Kalan Para: **${player.money}‚Ç∫**</p>
        <p>**Eƒüitim Seviyesi**: ${player.educationLevel}</p>
        <p>**Meslek**: ${player.job}</p>
        <p>${player.karma >= 0 ? "G√ºzel bir hayat ya≈üadƒ±n, ardƒ±nda iyi anƒ±lar bƒ±raktƒ±n." : "Hayatƒ±nda bazƒ± zorlu se√ßimler yaptƒ±n, ancak her deneyim bir derstir."}</p>
        <button onclick="location.reload()">Tekrar Dene</button>
      `;
      scene.clear();
      renderer.setClearColor(0x000000);
      info.style.display = 'none';
      militaryInfoDiv.style.display = 'none';
      gameControls.style.display = 'none';
    }


    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
