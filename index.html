<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>TC Ya≈üam Sim√ºlasyonu V3.1</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 30px;
      box-sizing: border-box;
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    h1 {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 2.5em;
    }
    label {
      display: block;
      margin: 10px 0;
      font-size: 1.1rem;
      width: 100%;
      max-width: 400px;
      text-align: left;
    }
    input, select, textarea {
      display: block;
      margin-top: 5px;
      padding: 12px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #555;
      background: #333;
      color: #fff;
      border-radius: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 15px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: background-color 0.3s ease;
      max-width: 300px;
      width: 100%;
    }
    button:hover {
      background-color: #45a049;
    }
    canvas { display: block; }
    #info, #event-overlay, #military-info, #psychologist-overlay, #game-controls, #shop-overlay {
      position: absolute;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      font-size: 16px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,255,0,0.3);
      border: 1px solid #4CAF50;
      z-index: 11;
    }
    #info {
      bottom: 20px;
      left: 20px;
      width: 300px;
    }
    #event-overlay, #psychologist-overlay, #shop-overlay {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      text-align: center;
      display: none;
    }
    #event-overlay h2, #psychologist-overlay h2, #shop-overlay h2 {
      color: #FFEB3B;
      margin-top: 0;
    }
    #event-overlay p, #psychologist-overlay p, #shop-overlay p {
      margin-bottom: 20px;
    }
    #event-overlay button, #psychologist-overlay button, #shop-overlay button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1rem;
      max-width: unset;
      width: auto;
    }
    .option-button {
      background-color: #2196F3;
    }
    .option-button:hover {
      background-color: #1976D2;
    }
    #military-info {
      top: 20px;
      right: 20px;
      display: none;
    }
    #psychologist-input {
      width: calc(100% - 24px);
      margin-bottom: 15px;
      height: 100px;
      resize: vertical;
    }
    #game-controls {
      bottom: 20px;
      right: 20px;
      display: none;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #game-controls .movement-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
    }
    #game-controls .movement-buttons button:nth-child(2) {
        grid-column: 2; /* Center the forward button */
    }
    #game-controls .movement-buttons button:nth-child(4) {
        grid-column: 2; /* Center the back button */
    }
    #game-controls button {
      margin: 0; /* Remove default margin */
      width: 100%;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    <h1>üçº TC Ya≈üam Sim√ºlasyonu üáπüá∑</h1>
    <label>Ad: <input id="name" placeholder="Adƒ±nƒ± gir" required></label>
    <label>Soyad: <input id="surname" placeholder="Soyadƒ±nƒ± gir" required></label>
    <label>Doƒüum Yƒ±lƒ±: <input type="number" id="year" value="2025"></label>
    <label>Hastalƒ±k (isteƒüe baƒülƒ±):
      <select id="disease">
        <option value="">Yok</option>
        <option value="k√∂r">G√∂rme Engeli</option>
        <option value="felc">Fel√ß</option>
        <option value="mide">Mide Sorunu</option>
      </select>
    </label>
    <label>Din Se√ß:
      <select id="religion">
        <option value="yok">Yok</option>
        <option value="islam">ƒ∞slam</option>
        <option value="hristiyan">Hristiyanlƒ±k</option>
        <option value="yahudi">Yahudilik</option>
        <option value="budist">Budizm</option>
      </select>
    </label>
    <button onclick="startLife()">Hayata Ba≈üla</button>
  </div>

  <div id="info"></div>
  <div id="event-overlay">
    <h2 id="event-title"></h2>
    <p id="event-message"></p>
    <div id="event-options"></div>
  </div>
  <div id="military-info">
    <p>≈ûafak Sayacƒ±: <span id="safak-counter"></span> g√ºn</p>
    <p>Askerlik Durumu: <span id="military-status"></span></p>
  </div>
  <div id="psychologist-overlay">
    <h2 id="psychologist-title">Psikolog Seansƒ±</h2>
    <p id="psychologist-message">Derdiƒüini yazarak anlatabilirsin. (Kalan k√ºf√ºr hakkƒ±n: <span id="curse-attempts"></span>)</p>
    <textarea id="psychologist-input" placeholder="Dertlerini buraya yaz..."></textarea>
    <div id="psychologist-response"></div>
    <button onclick="submitPsychologistInput()">G√∂nder</button>
    <button class="option-button" onclick="hidePsychologistOverlay()">Bitir</button>
  </div>

  <div id="shop-overlay">
    <h2>Maƒüaza</h2>
    <p>Ne satƒ±n almak istersin?</p>
    <div id="shop-items">
      <button onclick="buyItem('clothes')">Kƒ±yafet (200‚Ç∫)</button>
      <button onclick="buyItem('pants')">Pantolon (150‚Ç∫)</button>
    </div>
    <p id="shop-message"></p>
    <button class="option-button" onclick="hideShopOverlay()">√áƒ±k</button>
  </div>

  <div id="game-controls">
    <div class="movement-buttons">
      <button onclick="movePlayer('left')">SOL</button>
      <button onclick="movePlayer('forward')">ƒ∞LERƒ∞</button>
      <button onclick="movePlayer('right')">SAƒû</button>
      <button onclick="movePlayer('back')" style="grid-column: 2;">GERƒ∞</button>
    </div>
    <button onclick="toggleWalkAnimation()">Y√ºr√º/Dur</button>
    <button onclick="toggleRunAnimation()">Ko≈ü/Dur</button>
    <button onclick="enterBuilding('shop')">Maƒüazaya Gir</button>
    <button onclick="enterBuilding('hospital')">Hastaneye Gir</button>
    <button onclick="enterBuilding('halƒ±saha')">Halƒ±sahaya Git</button>
  </div>


  <audio id="cry" src="https://www.soundjay.com/human/sounds/baby-crying-01.mp3"></audio>
  <audio id="voiceMom" src="https://www.soundjay.com/human/sounds/female-voice-01.mp3"></audio>
  <audio id="voiceDad" src="https://www.soundjay.com/human/sounds/male-voice-01.mp3"></audio>
  <audio id="explosion" src="https://www.soundjay.com/misc/sounds/explosion-01.mp3"></audio>
  <audio id="carHorn" src="https://www.soundjay.com/vehicles/sounds/car-horn-01.mp3"></audio>
  <audio id="fightSound" src="https://www.soundjay.com/fight/sounds/punch-01.mp3"></audio>


  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    // --- Three.js Setup ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("gameCanvas"), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x87CEEB); // Sky blue background
    renderer.shadowMap.enabled = true; // Enable shadows
    renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows
    camera.position.set(0, 2, 8);

    // Lights
    const ambientLight = new THREE.AmbientLight(0x404040, 2);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
    directionalLight.position.set(5, 10, 7);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 1024;
    directionalLight.shadow.mapSize.height = 1024;
    directionalLight.shadow.camera.near = 0.5;
    directionalLight.shadow.camera.far = 50;
    directionalLight.shadow.camera.left = -10;
    directionalLight.shadow.camera.right = 10;
    directionalLight.shadow.camera.top = 10;
    directionalLight.shadow.camera.bottom = -10;
    scene.add(directionalLight);

    // Ground plane (Grass)
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(100, 100),
      new THREE.MeshStandardMaterial({ color: 0x558B2F, side: THREE.DoubleSide }) // Darker green
    );
    plane.rotation.x = Math.PI / 2;
    plane.receiveShadow = true;
    scene.add(plane);

    // GLTF Loader (for future complex models)
    const loader = new THREE.GLTFLoader();

    // Player and NPC Objects (initially placeholder, will be replaced by GLTF models)
    let playerObject, momObject, dadObject;
    let mixerPlayer, mixerMom, mixerDad; // For animation mixers
    const clock = new THREE.Clock();

    // Player Animation States
    let isWalking = false;
    let isRunning = false;

    // --- Human Model Creator ---
    // This is a more complex placeholder for a human-like figure (joystick will control this)
    function createHumanModel(colorBody, colorClothes, colorPants, colorEyes) {
        const body = new THREE.Mesh(
            new THREE.CylinderGeometry(0.3, 0.5, 1.2, 32), // Torso
            new THREE.MeshStandardMaterial({ color: colorBody, roughness: 0.6 })
        );
        body.position.y = 0.6;

        const head = new THREE.Mesh(
            new THREE.SphereGeometry(0.3, 32, 32),
            new THREE.MeshStandardMaterial({ color: colorBody, roughness: 0.6 })
        );
        head.position.y = 1.5; // On top of body

        const leftArm = new THREE.Mesh(
            new THREE.CapsuleGeometry(0.1, 0.6, 32, 32),
            new THREE.MeshStandardMaterial({ color: colorBody, roughness: 0.6 })
        );
        leftArm.position.set(-0.4, 0.9, 0);
        leftArm.rotation.z = Math.PI / 8;

        const rightArm = leftArm.clone();
        rightArm.position.x = 0.4;
        rightArm.rotation.z = -Math.PI / 8;

        const leftLeg = new THREE.Mesh(
            new THREE.CapsuleGeometry(0.12, 0.7, 32, 32),
            new THREE.MeshStandardMaterial({ color: colorBody, roughness: 0.6 })
        );
        leftLeg.position.set(-0.2, -0.1, 0);

        const rightLeg = leftLeg.clone();
        rightLeg.position.x = 0.2;

        const shirt = new THREE.Mesh(
            new THREE.CylinderGeometry(0.32, 0.52, 0.6, 32), // Simple shirt over torso
            new THREE.MeshStandardMaterial({ color: colorClothes, roughness: 0.8 })
        );
        shirt.position.y = 0.9;

        const pants = new THREE.Mesh(
            new THREE.CylinderGeometry(0.3, 0.35, 0.7, 32), // Simple pants
            new THREE.MeshStandardMaterial({ color: colorPants, roughness: 0.8 })
        );
        pants.position.y = 0.2;

        const leftEye = new THREE.Mesh(
            new THREE.SphereGeometry(0.05, 16, 16),
            new THREE.MeshStandardMaterial({ color: colorEyes })
        );
        leftEye.position.set(-0.15, 1.6, 0.25);

        const rightEye = leftEye.clone();
        rightEye.position.x = 0.15;

        const mouth = new THREE.Mesh(
            new THREE.BoxGeometry(0.2, 0.05, 0.05),
            new THREE.MeshStandardMaterial({ color: 0x8B0000 })
        );
        mouth.position.set(0, 1.4, 0.25);

        const group = new THREE.Group();
        group.add(body, head, leftArm, rightArm, leftLeg, rightLeg, shirt, pants, leftEye, rightEye, mouth);
        group.castShadow = true;
        group.receiveShadow = true;
        return group;
    }


    // --- Scene Creation Functions (Updated to hint at GLTF loading) ---
    let currentEnvironment = ""; // To keep track of current scene

    function createBirthScene() {
      // Clear all existing objects except lights and ground
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Simple baby model (Sphere for now, replace with GLTF)
      const baby = new THREE.Mesh(
        new THREE.SphereGeometry(0.4, 32, 32),
        new THREE.MeshStandardMaterial({ color: 0xffccaa, roughness: 0.7, metalness: 0.1 })
      );
      baby.position.y = 0.5;
      baby.name = "baby";
      scene.add(baby);

      const bed = new THREE.Mesh(
        new THREE.BoxGeometry(2, 0.2, 1),
        new THREE.MeshStandardMaterial({ color: 0x8b4513, roughness: 0.8 })
      );
      bed.position.y = 0;
      scene.add(bed);

      // Parent models using human model creator
      momObject = createHumanModel(0xffccaa, 0xff69b4, 0x5F9EA0, 0x000000); // Pink shirt, cyan pants
      momObject.scale.set(0.7, 0.7, 0.7);
      momObject.position.set(-1.5, momObject.scale.y * 0.8, 0); // Adjust position based on scale
      momObject.name = "mom";
      scene.add(momObject);

      dadObject = createHumanModel(0xffccaa, 0x4682B4, 0x2F4F4F, 0x000000); // Steelblue shirt, dark slate gray pants
      dadObject.scale.set(0.8, 0.8, 0.8);
      dadObject.position.set(1.5, dadObject.scale.y * 0.8, 0);
      dadObject.name = "dad";
      scene.add(dadObject);


      currentEnvironment = "birth";
      camera.position.set(0, 1.6, 5); // Closer view for birth
    }

    function createHomeScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Room elements - more defined walls and floor
      const wallsMaterial = new THREE.MeshStandardMaterial({ color: 0xAAAAAA, side: THREE.BackSide, roughness: 0.8 });
      const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 }); // Wooden floor
      const ceilingMaterial = new THREE.MeshStandardMaterial({ color: 0xEEEEEE });

      const roomSize = 12;
      const wallHeight = 4;

      const floor = new THREE.Mesh(new THREE.BoxGeometry(roomSize, 0.1, roomSize), floorMaterial);
      floor.position.y = -0.05;
      scene.add(floor);

      const ceiling = new THREE.Mesh(new THREE.BoxGeometry(roomSize, 0.1, roomSize), ceilingMaterial);
      ceiling.position.y = wallHeight - 0.05;
      scene.add(ceiling);

      // Walls
      const wall1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, wallHeight, roomSize), wallsMaterial);
      wall1.position.set(-roomSize / 2, wallHeight / 2 - 0.05, 0);
      scene.add(wall1);
      const wall2 = new THREE.Mesh(new THREE.BoxGeometry(0.1, wallHeight, roomSize), wallsMaterial);
      wall2.position.set(roomSize / 2, wallHeight / 2 - 0.05, 0);
      scene.add(wall2);
      const wall3 = new THREE.Mesh(new THREE.BoxGeometry(roomSize, wallHeight, 0.1), wallsMaterial);
      wall3.position.set(0, wallHeight / 2 - 0.05, -roomSize / 2);
      scene.add(wall3);
      const wall4 = new THREE.Mesh(new THREE.BoxGeometry(roomSize, wallHeight, 0.1), wallsMaterial);
      wall4.position.set(0, wallHeight / 2 - 0.05, roomSize / 2);
      scene.add(wall4);

      // Player object
      if (!playerObject) {
        playerObject = createHumanModel(0xffdcb9, 0x6495ED, 0x8B0000, 0x000000); // Player's initial colors
      }
      playerObject.position.set(0, playerObject.scale.y * 0.8, 0);
      scene.add(playerObject);

      // Parent models (re-create if not existing, or update their positions)
      if (!momObject) {
        momObject = createHumanModel(0xffccaa, 0xff69b4, 0x5F9EA0, 0x000000);
      }
      momObject.position.set(-3, momObject.scale.y * 0.8, -3);
      scene.add(momObject);

      if (!dadObject) {
        dadObject = createHumanModel(0xffccaa, 0x4682B4, 0x2F4F4F, 0x000000);
      }
      dadObject.position.set(3, dadObject.scale.y * 0.8, -3);
      scene.add(dadObject);


      // Simple furniture
      const table = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.7, 0.8), new THREE.MeshStandardMaterial({ color: 0x552200 }));
      table.position.set(2, 0.35, -2);
      scene.add(table);
      const chair = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.5), new THREE.MeshStandardMaterial({ color: 0x774411 }));
      chair.position.set(2, 0.4, -1.5);
      scene.add(chair);

      currentEnvironment = "home";
      camera.position.set(0, 2, 5); // Adjust camera for home view
    }

    // New scene for school, dynamically changes based on age
    function createSchoolScene(grade) {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // School Building walls (to create an indoor classroom feel)
      const wallsMaterial = new THREE.MeshStandardMaterial({ color: 0xDAA520, side: THREE.BackSide, roughness: 0.8 }); // Goldenrod
      const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xDEB887 }); // BurlyWood
      const ceilingMaterial = new THREE.MeshStandardMaterial({ color: 0xF5DEB3 }); // Wheat

      const roomSize = 15;
      const wallHeight = 6;

      const floor = new THREE.Mesh(new THREE.BoxGeometry(roomSize, 0.1, roomSize), floorMaterial);
      floor.position.y = -0.05;
      scene.add(floor);

      const ceiling = new THREE.Mesh(new THREE.BoxGeometry(roomSize, 0.1, roomSize), ceilingMaterial);
      ceiling.position.y = wallHeight - 0.05;
      scene.add(ceiling);

      const wall1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, wallHeight, roomSize), wallsMaterial);
      wall1.position.set(-roomSize / 2, wallHeight / 2 - 0.05, 0);
      scene.add(wall1);
      const wall2 = new THREE.Mesh(new THREE.BoxGeometry(0.1, wallHeight, roomSize), wallsMaterial);
      wall2.position.set(roomSize / 2, wallHeight / 2 - 0.05, 0);
      scene.add(wall2);
      const wall3 = new THREE.Mesh(new THREE.BoxGeometry(roomSize, wallHeight, 0.1), wallsMaterial);
      wall3.position.set(0, wallHeight / 2 - 0.05, -roomSize / 2);
      scene.add(wall3);
      const wall4 = new THREE.Mesh(new THREE.BoxGeometry(roomSize, wallHeight, 0.1), wallsMaterial);
      wall4.position.set(0, wallHeight / 2 - 0.05, roomSize / 2);
      scene.add(wall4);

      // Blackboard
      const blackboard = new THREE.Mesh(
        new THREE.BoxGeometry(4, 2, 0.1),
        new THREE.MeshStandardMaterial({ color: 0x000000 })
      );
      blackboard.position.set(0, 2.5, -roomSize / 2 + 0.1); // Against back wall
      scene.add(blackboard);

      // Teacher Desk
      const teacherDesk = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 0.8, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
      );
      teacherDesk.position.set(0, 0.4, -roomSize / 2 + 1.5);
      scene.add(teacherDesk);

      // Desks and chairs
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 3; j++) {
          const studentDesk = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 0.6, 0.6),
            new THREE.MeshStandardMaterial({ color: 0x552200 })
          );
          studentDesk.position.set(i * 2 - 3, 0.3, j * 2 - 2);
          scene.add(studentDesk);

          const studentChair = new THREE.Mesh(
            new THREE.BoxGeometry(0.4, 0.7, 0.4),
            new THREE.MeshStandardMaterial({ color: 0x774411 })
          );
          studentChair.position.set(i * 2 - 3, 0.35, j * 2 - 2 + 0.5);
          scene.add(studentChair);
        }
      }

      if (playerObject) {
        playerObject.position.set(-2, playerObject.scale.y * 0.8, 2); // Player in classroom
      }
      scene.add(playerObject);

      // Update appearance based on grade (conceptual - would involve changing textures/models)
      if (grade === "ilkokul") {
         camera.position.set(0, 3, 7); // Closer view
      } else if (grade === "ortaokul") {
         camera.position.set(0, 3.5, 8);
      } else if (grade === "lise") {
         camera.position.set(0, 4, 9);
      } else if (grade === "√ºniversite") {
         // Maybe add a lecturer and bigger desks/auditorium feel
         camera.position.set(0, 5, 10);
      }

      currentEnvironment = "school";
      camera.position.set(0, 4, 10); // View from back of classroom
    }


    function createMilitaryScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Barracks/Training Ground feel
      const barracksWall = new THREE.Mesh(
        new THREE.BoxGeometry(10, 3, 0.5),
        new THREE.MeshStandardMaterial({ color: 0x666666 })
      );
      barracksWall.position.set(0, 1.5, -4);
      scene.add(barracksWall);

      const tent = new THREE.Mesh(
        new THREE.ConeGeometry(1.5, 2, 4),
        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
      );
      tent.position.set(3, 1, 0);
      scene.add(tent);

      if (playerObject) {
        playerObject.position.set(-2, playerObject.scale.y * 0.8, 2);
        // Player appearance for military (uniform - conceptual)
      }
      scene.add(playerObject);

      currentEnvironment = "military";
      camera.position.set(0, 4, 10);
    }

    function createCityScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      // Simple buildings
      const buildingMaterial = new THREE.MeshStandardMaterial({ color: 0x999999 });
      for (let i = 0; i < 7; i++) {
        const height = Math.random() * 8 + 4;
        const building = new THREE.Mesh(
          new THREE.BoxGeometry(Math.random() * 3 + 1, height, Math.random() * 3 + 1),
          buildingMaterial
        );
        building.position.set(Math.random() * 20 - 10, height / 2, Math.random() * 20 - 10);
        building.castShadow = true;
        scene.add(building);
      }

      // Road
      const road = new THREE.Mesh(
        new THREE.BoxGeometry(40, 0.05, 10),
        new THREE.MeshStandardMaterial({ color: 0x444444 })
      );
      road.position.z = -5;
      scene.add(road);

      // Sidewalks
      const sidewalkMaterial = new THREE.MeshStandardMaterial({ color: 0x777777 });
      const sidewalk1 = new THREE.Mesh(new THREE.BoxGeometry(40, 0.1, 2), sidewalkMaterial);
      sidewalk1.position.set(0, 0.05, 0);
      scene.add(sidewalk1);
      const sidewalk2 = new THREE.Mesh(new THREE.BoxGeometry(40, 0.1, 2), sidewalkMaterial);
      sidewalk2.position.set(0, 0.05, -10);
      scene.add(sidewalk2);

      if (playerObject) {
        playerObject.position.set(0, playerObject.scale.y * 0.8, 5); // Player on sidewalk
        // Update player appearance for adult/city life (clothes - conceptual)
      }
      scene.add(playerObject);

      currentEnvironment = "city";
      camera.position.set(0, 5, 15); // Wider view for city
    }

    function createShopScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      const shopFloor = new THREE.Mesh(
        new THREE.BoxGeometry(10, 0.1, 10),
        new THREE.MeshStandardMaterial({ color: 0xD3D3D3 }) // Light grey
      );
      shopFloor.position.y = -0.05;
      scene.add(shopFloor);

      const counter = new THREE.Mesh(
        new THREE.BoxGeometry(3, 1, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
      );
      counter.position.set(0, 0.5, -4);
      scene.add(counter);

      const shelves = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 2.5, 5),
        new THREE.MeshStandardMaterial({ color: 0xA9A9A9 })
      );
      shelves.position.set(4.5, 1.25, 0);
      scene.add(shelves);

      if (playerObject) {
        playerObject.position.set(0, playerObject.scale.y * 0.8, 4);
      }
      scene.add(playerObject);
      currentEnvironment = "shop";
      camera.position.set(0, 2, 5);
    }

    function createHospitalScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      const hospitalFloor = new THREE.Mesh(
        new THREE.BoxGeometry(15, 0.1, 15),
        new THREE.MeshStandardMaterial({ color: 0xF5F5DC }) // Off-white
      );
      hospitalFloor.position.y = -0.05;
      scene.add(hospitalFloor);

      const bed = new THREE.Mesh(
        new THREE.BoxGeometry(2, 0.5, 1),
        new THREE.MeshStandardMaterial({ color: 0x808080 })
      );
      bed.position.set(-3, 0.25, 0);
      scene.add(bed);

      const doctorDesk = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 0.8, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x2F4F4F })
      );
      doctorDesk.position.set(3, 0.4, 0);
      scene.add(doctorDesk);

      if (playerObject) {
        playerObject.position.set(0, playerObject.scale.y * 0.8, 5);
      }
      scene.add(playerObject);
      currentEnvironment = "hospital";
      camera.position.set(0, 2, 5);
    }

    function createHalƒ±sahaScene() {
      scene.children.forEach(child => {
        if (child !== ambientLight && child !== directionalLight && child !== plane) {
          scene.remove(child);
        }
      });

      const field = new THREE.Mesh(
        new THREE.BoxGeometry(20, 0.1, 10),
        new THREE.MeshStandardMaterial({ color: 0x006400 }) // Dark green
      );
      field.position.y = -0.05;
      scene.add(field);

      const goal1 = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 2, 4),
        new THREE.MeshStandardMaterial({ color: 0xFFFFFF })
      );
      goal1.position.set(-9.5, 1, 0);
      scene.add(goal1);

      const goal2 = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 2, 4),
        new THREE.MeshStandardMaterial({ color: 0xFFFFFF })
      );
      goal2.position.set(9.5, 1, 0);
      scene.add(goal2);

      if (playerObject) {
        playerObject.position.set(0, playerObject.scale.y * 0.8, 0);
      }
      scene.add(playerObject);
      currentEnvironment = "halƒ±saha";
      camera.position.set(0, 5, 15);
    }

    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();
      if (mixerPlayer) mixerPlayer.update(delta); // Update player animations
      if (mixerMom) mixerMom.update(delta); // Update mom animations
      if (mixerDad) mixerDad.update(delta); // Update dad animations

      // Joystick-like movement
      if (playerObject) {
        let speed = 0;
        if (isWalking) speed = 0.05;
        if (isRunning) speed = 0.1;

        if (speed > 0) {
            // Apply movement based on current rotation
            playerObject.position.x += Math.sin(playerObject.rotation.y) * speed;
            playerObject.position.z += Math.cos(playerObject.rotation.y) * speed;

            // Simple "walking" animation for placeholder model
            playerObject.children[3].rotation.x = Math.sin(clock.getElapsedTime() * 10 * (speed * 10)) * 0.5; // Left arm
            playerObject.children[4].rotation.x = -Math.sin(clock.getElapsedTime() * 10 * (speed * 10)) * 0.5; // Right arm
            playerObject.children[5].rotation.x = -Math.sin(clock.getElapsedTime() * 10 * (speed * 10)) * 0.5; // Left leg
            playerObject.children[6].rotation.x = Math.sin(clock.getElapsedTime() * 10 * (speed * 10)) * 0.5; // Right leg
        } else {
            // Reset limbs to neutral position when not moving
            playerObject.children[3].rotation.x = 0;
            playerObject.children[4].rotation.x = 0;
            playerObject.children[5].rotation.x = 0;
            playerObject.children[6].rotation.x = 0;
        }

        // Parent animations (simple walking placeholder)
        if (momObject && currentEnvironment === "home") {
            momObject.position.x += Math.sin(clock.getElapsedTime() * 0.5) * 0.01;
            momObject.position.z += Math.cos(clock.getElapsedTime() * 0.5) * 0.01;
            // Simple "walking" animation for placeholder model
            momObject.children[3].rotation.x = Math.sin(clock.getElapsedTime() * 5) * 0.5; // Left arm
            momObject.children[4].rotation.x = -Math.sin(clock.getElapsedTime() * 5) * 0.5; // Right arm
            momObject.children[5].rotation.x = -Math.sin(clock.getElapsedTime() * 5) * 0.5; // Left leg
            momObject.children[6].rotation.x = Math.sin(clock.getElapsedTime() * 5) * 0.5; // Right leg
        }
        if (dadObject && currentEnvironment === "home") {
            dadObject.position.x -= Math.sin(clock.getElapsedTime() * 0.4) * 0.01;
            dadObject.position.z += Math.cos(clock.getElapsedTime() * 0.4) * 0.01;
            // Simple "walking" animation for placeholder model
            dadObject.children[3].rotation.x = Math.sin(clock.getElapsedTime() * 4) * 0.5; // Left arm
            dadObject.children[4].rotation.x = -Math.sin(clock.getElapsedTime() * 4) * 0.5; // Right arm
            dadObject.children[5].rotation.x = -Math.sin(clock.getElapsedTime() * 4) * 0.5; // Left leg
            dadObject.children[6].rotation.x = Math.sin(clock.getElapsedTime() * 4) * 0.5; // Right leg
        }
      }


      renderer.render(scene, camera);
    }
    animate();

    // --- Game Logic ---
    const info = document.getElementById("info");
    const eventOverlay = document.getElementById("event-overlay");
    const eventTitle = document.getElementById("event-title");
    const eventMessage = document.getElementById("event-message");
    const eventOptions = document.getElementById("event-options");
    const militaryInfoDiv = document.getElementById("military-info");
    const safakCounterSpan = document.getElementById("safak-counter");
    const militaryStatusSpan = document.getElementById("military-status");
    const psychologistOverlay = document.getElementById("psychologist-overlay");
    const psychologistInput = document.getElementById("psychologist-input");
    const psychologistResponseDiv = document.getElementById("psychologist-response");
    const curseAttemptsSpan = document.getElementById("curse-attempts");
    const gameControls = document.getElementById("game-controls");
    const shopOverlay = document.getElementById("shop-overlay");
    const shopMessage = document.getElementById("shop-message");

    let player = {
      name: "",
      surname: "",
      year: 2025,
      age: 0,
      money: 1000, // Ba≈ülangƒ±√ß parasƒ±
      disease: "",
      religion: "",
      family: Math.random() < 0.5 ? "Zengin" : "Fakir",
      karma: 0, // Amel Defteri
      hasCar: false,
      hasHouse: false,
      isMarried: false,
      militaryStatus: "Muaf Deƒüil",
      militaryServiceRemaining: 0,
      militaryDraftAttempts: 0,
      educationLevel: "Okul √ñncesi", // ƒ∞lkokul, Ortaokul, Lise, √úniversite, Mezun
      job: "ƒ∞≈üsiz",
      psychologicalHealth: 100, // Max 100, lower is worse
      curseCount: 0,
      psychologistBanUntil: 0, // Year when ban lifts
      hasPubertyAcne: false,
      hasBodyHair: false,
      playerClothesColor: 0x6495ED, // Initial clothes color
      playerPantsColor: 0x8B0000 // Initial pants color
    };

    let ageInterval;
    let militaryInterval;
    const utterance = new SpeechSynthesisUtterance();
    utterance.lang = 'tr-TR'; // Turkish language for speech synthesis

    // Other NPCs (conceptual, will need their own models/data)
    let siblings = [];
    let friends = [];

    // --- Core Game Functions ---

    function startLife() {
      const nameInput = document.getElementById("name").value;
      const surnameInput = document.getElementById("surname").value;

      if (!nameInput || !surnameInput) {
        alert("Ad ve Soyad bo≈ü bƒ±rakƒ±lamaz!");
        return;
      }

      player.name = nameInput;
      player.surname = surnameInput;
      player.year = parseInt(document.getElementById("year").value) || 2025;
      player.disease = document.getElementById("disease").value;
      player.religion = document.getElementById("religion").value;

      document.getElementById("cry").play();
      document.getElementById("ui").style.display = "none";
      gameControls.style.display = "flex"; // Show joystick controls

      if (player.disease === "k√∂r") {
        renderer.setClearColor(0x000000); // Black screen for blindness
        speakText("G√∂zlerin g√∂rm√ºyor. D√ºnyan karanlƒ±k.", null);
      } else {
        createBirthScene();
        speakText("Ho≈ü geldin bebeƒüim! Ben annen.", document.getElementById("voiceMom"));
        setTimeout(() => {
          speakText("Hayata g√∂zlerini a√ßtƒ±n evlat! Ben de baban.", document.getElementById("voiceDad"));
        }, 4000);
      }

      setTimeout(() => {
        spawnAtHome();
      }, 6000);
    }

    function speakText(text, audioElem = null) {
      if (audioElem) {
        audioElem.play();
      }
      utterance.text = text;
      speechSynthesis.speak(utterance);
    }

    function spawnAtHome() {
      createHomeScene();
      player.age = 0;
      updateInfo();

      // Create siblings with a chance
      if (Math.random() < 0.6) { // 60% chance to have a sibling
        const siblingGender = Math.random() < 0.5 ? "Erkek" : "Kƒ±z";
        const siblingName = siblingGender === "Erkek" ? "Ali" : "Ay≈üe"; // Simple names for now
        siblings.push({ name: siblingName, gender: siblingGender, age: 0 });
        speakText(`Bir de ${siblingName} adƒ±nda karde≈üin oldu!`, document.getElementById("voiceMom"));
      }


      ageInterval = setInterval(() => {
        player.age++;
        updateInfo();
        updatePlayerAppearance(); // Update player model based on age
        handleLifeEvents();
      }, 5000); // Each 5 seconds is 1 year
    }

    function updatePlayerAppearance() {
      // Remove old player object to update its properties
      if (playerObject) {
          scene.remove(playerObject);
      }

      // Recreate player object with potentially updated colors/sizes
      let bodyColor = 0xffdcb9; // Default skin color
      let clothesColor = player.playerClothesColor;
      let pantsColor = player.playerPantsColor;
      let eyesColor = 0x000000; // Default eye color

      if (player.hasPubertyAcne && player.age >= 13) {
          bodyColor = 0xFFC0CB; // Slightly reddish/pinkish for acne
      }

      playerObject = createHumanModel(bodyColor, clothesColor, pantsColor, eyesColor);
      playerObject.position.set(0, 0, 0); // Reset position (will be handled by movement)

      let scaleFactor = 0.3; // Default for baby/toddler
      if (player.age < 6) {
        scaleFactor = 0.4; // Baby/Toddler look (smaller, rounder)
      } else if (player.age >= 6 && player.age < 12) {
        scaleFactor = 0.6; // Child look
        player.educationLevel = "ƒ∞lkokul";
      } else if (player.age >= 12 && player.age < 18) {
        scaleFactor = 0.8; // Teenager look
        player.educationLevel = "Ortaokul";
        handlePubertyChanges();
      } else if (player.age >= 18 && player.age < 22) {
        scaleFactor = 1.0;
        player.educationLevel = "Lise";
      } else if (player.age >= 22 && player.age < 26) {
        scaleFactor = 1.0;
        player.educationLevel = "√úniversite";
      } else if (player.age >= 26) {
        scaleFactor = 1.0;
        player.educationLevel = "Mezun";
      }
      playerObject.scale.set(scaleFactor, scaleFactor, scaleFactor);
      playerObject.position.y = scaleFactor * 0.8; // Adjust y position based on new scale

      scene.add(playerObject);

      // Update parent appearance (simple scaling/animation for now)
      if (momObject) {
          momObject.scale.set(0.8, 0.8, 0.8);
          momObject.position.y = momObject.scale.y * 0.8;
      }
      if (dadObject) {
          dadObject.scale.set(0.9, 0.9, 0.9);
          dadObject.position.y = dadObject.scale.y * 0.8;
      }

      // For GLTF models, this is where you'd load new models or swap parts
      /*
      loader.load('path/to/aged_player_model.gltf', (gltf) => {
          if (playerObject) scene.remove(playerObject);
          playerObject = gltf.scene;
          playerObject.position.set(0, 0.8, 0); // Or current position
          playerObject.castShadow = true;
          scene.add(playerObject);
          mixerPlayer = new THREE.AnimationMixer(playerObject); // Assign to specific mixer
          // Load animations
      });
      */
    }

    function handlePubertyChanges() {
      if (player.age === 13 && !player.hasPubertyAcne) {
        showEvent("Ergenlik Belirtileri", "Y√ºz√ºnde sivilceler √ßƒ±kmaya ba≈üladƒ±! Ne yapacaksƒ±n?", [
          { text: "Sivilceleri patlat (Riskli)", action: () => {
              if (Math.random() < 0.5) {
                showEvent("Patlattƒ±n!", "Sivilce izleri kaldƒ± ve psikolojik saƒülƒ±ƒüƒ±n d√º≈üt√º.", [{ text: "Of!", action: () => { player.psychologicalHealth -= 5; } }]);
              } else {
                showEvent("Temizledin!", "Y√ºz√ºn biraz daha temiz g√∂r√ºn√ºyor.", [{ text: "ƒ∞yi", action: () => { player.karma += 1; } }]);
              }
              player.hasPubertyAcne = true; // Mark as handled for this event
              updatePlayerAppearance(); // To potentially show acne color
            }
          },
          { text: "Bakƒ±m yap (50‚Ç∫)", action: () => {
              if (player.money >= 50) {
                player.money -= 50;
                showEvent("Bakƒ±m Yaptƒ±n!", "Sivilcelerin azaldƒ±, psikolojik saƒülƒ±ƒüƒ±n arttƒ±.", [{ text: "Te≈üekk√ºrler", action: () => { player.psychologicalHealth += 5; player.hasPubertyAcne = false; } }]);
              } else {
                showEvent("Paran Yok", "Bakƒ±m i√ßin yeterli paran yok!", [{ text: "Pekala", action: () => { } }]);
              }
            }
          },
          { text: "Umursama", action: () => { showEvent("Devam et", "Sivilcelerin kaldƒ±.", [{ text: "Neyse", action: () => { player.hasPubertyAcne = true; } }]); } }
        ]);
      }
      if (player.age === 14 && !player.hasBodyHair) {
        showEvent("Kƒ±llanma", "V√ºcudunda kƒ±llanma ba≈üladƒ±. Ne yapacaksƒ±n?", [
          { text: "Tƒ±ra≈ü et/al", action: () => { showEvent("Bakƒ±m", "V√ºcudunu temizledin.", [{ text: "Ferahlƒ±k!", action: () => { player.hasBodyHair = true; } }]); } },
          { text: "Doƒüal bƒ±rak", action: () => { showEvent("Olduƒüu gibi", "Doƒüal halini benimsedin.", [{ text: "Tamamdƒ±r", action: () => { player.hasBodyHair = true; } }]); } }
        ]);
      }
    }


    function updateInfo() {
      info.innerHTML = `
        **${player.name} ${player.surname}**
        Ya≈ü: ${player.age} (${player.educationLevel})
        Din: ${player.religion}
        Aile: ${player.family}
        Para: ${player.money}‚Ç∫
        Karma: ${player.karma}
        Psikolojik Saƒülƒ±k: ${player.psychologicalHealth}/100
        ƒ∞≈ü: ${player.job}
        Ev: ${player.hasHouse ? "Var" : "Yok"}
        Araba: ${player.hasCar ? "Var" : "Yok"}
        Evlilik: ${player.isMarried ? "Evli" : "Bekar"}
        Askerlik: ${player.militaryStatus}
        Karde≈üler: ${siblings.length > 0 ? siblings.map(s => s.name).join(', ') : "Yok"}
      `;
    }

    function showEvent(title, message, options) {
      eventTitle.innerText = title;
      eventMessage.innerText = message;
      eventOptions.innerHTML = "";
      options.forEach(option => {
        const button = document.createElement("button");
        button.innerText = option.text;
        button.className = "option-button";
        button.onclick = () => {
          hideEvent();
          option.action();
        };
        eventOptions.appendChild(button);
      });
      eventOverlay.style.display = "flex";
      speakText(`${title}. ${message}`); // Speak event message
    }

    function hideEvent() {
      eventOverlay.style.display = "none";
    }

    function handleLifeEvents() {
      // --- Childhood & Education ---
      if (player.age === 6) {
        showEvent("Okula Ba≈ülama", "ƒ∞lkokula ba≈ülƒ±yorsun! Okula gitmek ister misin?", [
          { text: "Evet, okula git", action: () => { createSchoolScene("ilkokul"); player.karma += 5; speakText("Okula gitmeyi kabul ettin."); } },
          { text: "Hayƒ±r, gitmek istemiyorum", action: () => { player.karma -= 10; speakText("Okula gitmeyi reddettin. Bu kararƒ±n ileriki hayatƒ±nƒ± etkileyebilir."); createCityScene(); } }
        ]);
      } else if (player.age === 10 && player.educationLevel === "ƒ∞lkokul" && Math.random() < 0.2) { // Random school question
        if (currentEnvironment !== "school") { // Only ask if not already in school
            showEvent("Okulda Soru", "√ñƒüretmen sana bir soru sordu: 'T√ºrkiye'nin ba≈ükenti neresidir?'", [
            { text: "Ankara", action: () => { showEvent("Doƒüru Cevap!", "√ñƒüretmen seni tebrik etti.", [{ text: "Te≈üekk√ºrler", action: () => { player.karma += 2; } }]); } },
            { text: "ƒ∞stanbul", action: () => { showEvent("Yanlƒ±≈ü Cevap!", "√ñƒüretmen sana √ºz√ºld√º.", [{ text: "√úzg√ºn√ºm", action: () => { player.karma -= 1; } }]); } }
            ]);
        }
      } else if (player.age === 14 && player.educationLevel === "Ortaokul") {
        showEvent("Ortaokul Bitiyor", "Lise i√ßin hangi alana y√∂nelmek istersin?", [
          { text: "Fen Lisesi (Zeka)", action: () => { player.karma += 5; speakText("Fen lisesini se√ßtin."); } },
          { text: "Sosyal Bilimler Lisesi (Sosyal)", action: () => { player.karma += 3; speakText("Sosyal bilimler lisesini se√ßtin."); } },
          { text: "Meslek Lisesi (Pratik)", action: () => { player.karma += 2; speakText("Meslek lisesini se√ßtin."); } }
        ]);
      } else if (player.age === 18 && player.educationLevel === "Lise") {
        showEvent("Lise Bitti!", "√úniversiteye gitmek ister misin? (Sƒ±nav var!)", [
          { text: "Evet, sƒ±nava gir", action: () => { takeUniversityExam(); } },
          { text: "Hayƒ±r, direkt i≈ü hayatƒ±na atƒ±l", action: ()ÏÜåÎ•º: () => { player.job = "Niteliksiz ƒ∞≈ü√ßi"; player.money += 500; speakText("√úniversiteye gitmeyi tercih etmedin. ƒ∞≈ü hayatƒ±na atƒ±ldƒ±n."); createCityScene(); } }
        ]);
      }

      // --- Adulthood & Career ---
      if (player.age === 20 && player.militaryStatus === "Muaf Deƒüil" && player.militaryDraftAttempts < 3) {
        askForMilitaryService();
      } else if (player.age === 25 && !player.isMarried) {
        showEvent("Evlilik Zamanƒ±?", "Evlilik d√º≈ü√ºnceleri aklƒ±na gelmeye ba≈üladƒ±. Birini bulabilecek misin?", [
          { text: "Evet, birini ara", action: () => { attemptMarriage(); } },
          { text: "Hen√ºz deƒüil, kariyer √∂nceliƒüim", action: () => { player.money += 1000; speakText("Evlenmeyi erteledin."); } }
        ]);
      } else if (player.age === 26 && player.job === "ƒ∞≈üsiz" && player.educationLevel === "Mezun") {
        showEvent("Meslek Se√ßimi", "Hangi mesleƒüi yapmak istersin?", [
          { text: "Yazƒ±lƒ±mcƒ± (Y√ºksek Gelir)", action: () => { player.job = "Yazƒ±lƒ±mcƒ±"; player.money += 5000; speakText("Yazƒ±lƒ±mcƒ± oldun!"); createCityScene(); } },
          { text: "√ñƒüretmen (Orta Gelir)", action: () => { player.job = "√ñƒüretmen"; player.money += 2500; speakText("√ñƒüretmen oldun!"); createSchoolScene("mezun"); } }, // √ñƒüretmen olunca okula d√∂nebilir
          { text: "Esnaf (Deƒüi≈üken Gelir)", action: () => { player.job = "Esnaf"; player.money += 1500; speakText("Esnaf oldun!"); createShopScene(); } } // Esnaf olunca maƒüaza sahnesi
        ]);
      } else if (player.age === 30 && !player.hasHouse) {
        showEvent("Ev Alma Zamanƒ±?", "Bir ev satƒ±n almak ister misin? (5.000‚Ç∫)", [ // Fiyatƒ± d√º≈ü√ºrd√ºm ba≈ülangƒ±√ß i√ßin
          { text: "Evet, al", action: () => { buyHouse(); } },
          { text: "Hayƒ±r, kirada kal", action: () => { player.money -= 100; speakText("Kirada kalmayƒ± tercih ettin."); } }
        ]);
      } else if (player.age === 35 && !player.hasCar) {
        showEvent("Araba Alma Zamanƒ±?", "Bir araba almak ister misin? (2.000‚Ç∫)", [ // Fiyatƒ± d√º≈ü√ºrd√ºm ba≈ülangƒ±√ß i√ßin
          { text: "Evet, al", action: () => { buyCar(); } },
          { text: "Hayƒ±r, toplu ta≈üƒ±ma kullan", action: () => { speakText("Toplu ta≈üƒ±ma kullanmayƒ± tercih ettin."); } }
        ]);
      }

      // --- Social & Random Events ---
      if (player.age >= 18 && Math.random() < 0.05 && friends.length === 0) { // Chance to make friends after 18
        showEvent("Yeni Arkada≈ü", "Yeni bir arkada≈ü edinmek ister misin?", [
          { text: "Evet", action: () => { friends.push("Can"); showEvent("Arkada≈ülƒ±k", "Can adƒ±nda yeni bir arkada≈üƒ±n oldu!", [{ text: "Harika!", action: () => { speakText("Can adƒ±nda yeni bir arkada≈üƒ±n oldu!"); } }]); } },
          { text: "Hayƒ±r", action: () => { speakText("Arkada≈ü edinmeyi reddettin."); } }
        ]);
      } else if (player.age >= 18 && friends.length > 0 && Math.random() < 0.1) {
        showEvent("Halƒ±saha Ma√ßƒ±", "Arkada≈ülarƒ±nla halƒ± sahaya gitmek ister misin? (50‚Ç∫)", [
          { text: "Evet, git", action: () => { goToHalƒ±saha(); } },
          { text: "Hayƒ±r", action: () => { speakText("Halƒ±sahaya gitmeyi reddettin."); } }
        ]);
      }

      // Random psychological health events
      if (Math.random() < 0.08) { // 8% chance of psychological issue
        if (player.psychologicalHealth > 30) {
          showEvent("Psikolojik Destek", "Moralin bozuk ve kendini k√∂t√º hissediyorsun. Psikologdan yardƒ±m almak ister misin?", [
            { text: "Evet, git (200‚Ç∫)", action: () => { goToPsychologist(); } },
            { text: "Hayƒ±r, tek ba≈üƒ±ma atlatƒ±rƒ±m", action: () => { player.psychologicalHealth -= 10; speakText("Psikolojik saƒülƒ±ƒüƒ±n k√∂t√ºle≈üti."); } }
          ]);
        }
      }

      // General random events
      if (Math.random() < 0.1 && player.age >= 18) {
        handleRandomEvent();
      }

      // Sibling marriage event
      siblings.forEach(sibling => {
          if (sibling.age >= 25 && !sibling.isMarried && Math.random() < 0.1) {
              sibling.isMarried = true;
              showEvent("D√ºƒü√ºn Duyurusu", `${sibling.name} karde≈üin evleniyor! D√ºƒü√ºne katƒ±lmak ister misin?`, [
                  { text: "Evet, katƒ±lƒ±rƒ±m", action: () => { showEvent("D√ºƒü√ºn", "Karde≈üinin d√ºƒü√ºn√ºnde √ßok eƒülendin!", [{ text: "Tebrikler!", action: () => { player.karma += 5; speakText("Karde≈üinin d√ºƒü√ºn√ºne katƒ±ldƒ±n."); createCityScene(); } }]); } },
                  { text: "Hayƒ±r, i≈üim var", action: () => { showEvent("Ka√ßƒ±rdƒ±n", "Karde≈üinin d√ºƒü√ºn√ºn√º ka√ßƒ±rdƒ±n. Belki de gitmeliydin...", [{ text: "√úzg√ºn√ºm", action: () => { player.karma -= 2; speakText("Karde≈üinin d√ºƒü√ºn√ºn√º ka√ßƒ±rdƒ±n."); createCityScene(); } }]); } }
              ]);
          }
      });


      // --- End Game ---
      if (player.age >= 80) {
        showEvent("Son Yƒ±llar", "Hayatƒ±nƒ±n son demlerindesin. Geride ne bƒ±rakacaksƒ±n?", [
          { text: "Hayata veda et...", action: () => { endGame(); } }
        ]);
      }
    }

    // --- Education Related Functions ---
    function takeUniversityExam() {
      hideEvent();
      showEvent("√úniversite Sƒ±navƒ±", "≈ûimdi √ºniversite sƒ±navƒ±na gireceksin. Sorularƒ± cevapla!", [
        { text: "Ba≈üla", action: () => { startUniversityExam(); } }
      ]);
    }

    let examScore = 0;
    let cheatAttempted = false;

    function startUniversityExam() {
      examScore = 0;
      cheatAttempted = false;
      if (player.psychologistBanUntil > player.year + player.age) {
          showEvent("Sƒ±nav Yasaƒüƒ±!", `Psikologdan atƒ±ldƒ±ƒüƒ±n i√ßin ${player.psychologistBanUntil - player.age} ya≈üƒ±na kadar sƒ±nava giremezsin!`, [ // Ya≈üƒ±na g√∂re ban yƒ±lƒ±nƒ± g√∂ster
              { text: "Pekala", action: () => { createCityScene(); } }
          ]);
          return;
      }

      const questions = [
        { q: "T√ºrkiye'nin ba≈ükenti neresidir?", a: ["Adana", "Ankara", "ƒ∞stanbul", "ƒ∞zmir"], correct: 1 },
        { q: "2 + 2 ka√ß eder?", a: ["3", "4", "5", "6"], correct: 1 },
        { q: "Hangi gezegen G√ºne≈ü'e en yakƒ±ndƒ±r?", a: ["D√ºnya", "Mars", "Merk√ºr", "Ven√ºs"], correct: 2 },
        { q: "Atat√ºrk hangi ilde doƒümu≈ütur?", a: ["ƒ∞zmir", "Ankara", "Selanik", "ƒ∞stanbul"], correct: 2 },
      ];

      let currentQuestionIndex = 0;

      function askQuestion() {
        if (currentQuestionIndex < questions.length) {
          const q = questions[currentQuestionIndex];
          const options = q.a.map((ans, idx) => ({
            text: ans,
            action: () => {
              if (idx === q.correct) {
                examScore += 25; // Each question is 25 points
                showEvent("Doƒüru!", `Puanƒ±n: ${examScore}`, [{ text: "Devam", action: () => { currentQuestionIndex++; askQuestion(); } }]);
              } else {
                showEvent("Yanlƒ±≈ü!", `Puanƒ±n: ${examScore}`, [{ text: "Devam", action: () => { currentQuestionIndex++; askQuestion(); } }]);
              }
            }
          }));

          options.push({ text: "Kopya √áek (Riskli)", action: () => { attemptCheat(); } });

          showEvent(`Sƒ±nav Sorusu ${currentQuestionIndex + 1}`, q.q, options);
        } else {
          finishExam();
        }
      }

      function attemptCheat() {
        if (Math.random() < 0.4) { // 40% chance of getting caught
          showEvent("Kopya √áekerken Yakalandƒ±n!", "Sƒ±navƒ±n iptal edildi! 1 ila 3 yƒ±l arasƒ± sƒ±nava giremeyeceksin. Yardƒ±m edenler de ceza alacak.", [
            { text: "Eyvah!", action: () => {
                cheatAttempted = true;
                const banYears = Math.floor(Math.random() * 3) + 1; // 1 to 3 years ban
                player.psychologistBanUntil = player.year + player.age + banYears; // Using this property for exam ban
                player.karma -= 20; // Karma d√º≈ü√º≈ü√º
                finishExam(); // End exam prematurely
              }
            }
          ]);
        } else {
          examScore += 50; // Big boost for successful cheat
          showEvent("Kopya Ba≈üarƒ±lƒ±!", "Kimse g√∂rmedi. Puanƒ±n arttƒ±!", [
            { text: "≈ûanslƒ±yƒ±m!", action: () => { currentQuestionIndex++; askQuestion(); } }
          ]);
        }
      }

      function finishExam() {
        if (cheatAttempted) {
          showEvent("Sƒ±nav Sonucu", `Kopya nedeniyle sƒ±navƒ±n iptal edildi. ${player.psychologistBanUntil - (player.year + player.age)} yƒ±l sƒ±nava giremezsin.`, [
            { text: "Pekala", action: () => { player.educationLevel = "Lise Mezunu"; createCityScene(); } }
          ]);
          speakText(`Kopya nedeniyle sƒ±navƒ±n iptal edildi.`);
          return;
        }

        if (examScore >= 60) {
          showEvent("Sƒ±navƒ± Ge√ßtin!", `Tebrikler! ${examScore} puanla √ºniversiteyi kazandƒ±n.`, [
            { text: "Ya≈üasƒ±n!", action: () => { player.educationLevel = "√úniversite √ñƒürencisi"; player.money -= 500; speakText("√úniversiteye kayƒ±t oldun."); createSchoolScene("√ºniversite"); } }
          ]);
        } else {
          showEvent("Sƒ±navƒ± Ge√ßemedin", `Maalesef ${examScore} puanla sƒ±navƒ± ge√ßemedin.`, [
            { text: "Tekrar deneyeceƒüim", action: () => { player.educationLevel = "Lise Mezunu"; createCityScene(); } }
          ]);
          speakText(`Sƒ±navƒ± ge√ßemedin.`);
        }
      }

      askQuestion();
    }


    // --- Military Related Functions ---
    function askForMilitaryService() {
      player.militaryDraftAttempts++;
      showEvent("Askerlik √áaƒürƒ±sƒ±", "20 ya≈üƒ±na geldin ve askerlik √ßaƒürƒ±n geldi. Ne yapmak istersin?", [
        { text: "Askerliƒüe git (Normal)", action: () => { startMilitaryService("normal"); } },
        { text: "Bedelli yap (180.000‚Ç∫)", action: () => { startMilitaryService("bedelli"); } },
        { text: "≈ûimdilik gitme (5 yƒ±l sonra tekrar sorulacak)", action: () => { speakText("Askerliƒüi erteledin."); } }
      ]);

      if (player.militaryDraftAttempts >= 3 && player.militaryStatus === "Muaf Deƒüil") {
        showEvent("Zorunlu Askerlik!", "√áok fazla ka√ßtƒ±n! Artƒ±k zorla askere alƒ±nƒ±yorsun.", [
          { text: "Tamamdƒ±r...", action: () => { startMilitaryService("normal"); speakText("Zorla askere alƒ±ndƒ±n."); } }
        ]);
      }
    }

    function startMilitaryService(type) {
      clearInterval(ageInterval);
      createMilitaryScene();
      militaryInfoDiv.style.display = "block";

      if (type === "normal") {
        player.militaryStatus = "Askere Gitti";
        player.militaryServiceRemaining = 365;
        showEvent("Askerlik Ba≈üladƒ±!", "Kƒ±≈ülaya katƒ±ldƒ±n. Yeni hayatƒ±na ho≈ü geldin!", [
          { text: "G√∂rev bilinciyle...", action: () => { player.karma += 10; speakText("Askerlik g√∂revine ba≈üladƒ±n."); } }
        ]);
        militaryInterval = setInterval(updateMilitaryService, 1000);
      } else if (type === "bedelli") {
        if (player.money >= 180000) {
          player.money -= 180000;
          player.militaryStatus = "Bedelli Yaptƒ±";
          player.militaryServiceRemaining = 21;
          showEvent("Bedelli Yaptƒ±n!", "Paralƒ± askerlik hizmetini tamamladƒ±n. Hayatƒ±na devam edebilirsin.", [
            { text: "Oh be!", action: () => { speakText("Bedelli askerliƒüi tamamladƒ±n."); } }
          ]);
          militaryInterval = setInterval(updateMilitaryService, 500);
        } else {
          showEvent("Yetersiz Para", "Bedelli askerlik i√ßin yeterli paran yok! Normal askerlik veya erteleme se√ßmelisin.", [
            { text: "Anladƒ±m", action: () => { askForMilitaryService(); speakText("Yeterli paran yok."); } }
          ]);
          player.militaryStatus = "Muaf Deƒüil";
          ageInterval = setInterval(() => {
            player.age++;
            updateInfo();
            handleLifeEvents();
          }, 5000);
        }
      }
    }

    function updateMilitaryService() {
      player.militaryServiceRemaining--;
      safakCounterSpan.innerText = player.militaryServiceRemaining;
      militaryStatusSpan.innerText = player.militaryStatus;

      if (player.militaryServiceRemaining <= 0) {
        clearInterval(militaryInterval);
        militaryInfoDiv.style.display = "none";
        player.militaryStatus = "Terhis";
        showEvent("Terhis!", "Askerliƒüin bitti! Sivil hayata geri d√∂n√ºyorsun.", [
          { text: "Hayƒ±rlƒ± teskereler!", action: () => { createCityScene(); speakText("Askerliƒüin sona erdi."); } }
        ]);
        ageInterval = setInterval(() => {
          player.age++;
          updateInfo();
          handleLifeEvents();
        }, 5000);
      } else if (player.militaryStatus === "Askere Gitti") {
        if (player.militaryServiceRemaining % 30 === 0) {
          const randomEvent = Math.random();
          if (randomEvent < 0.3) {
            showEvent("Askerlik Olayƒ±", "Patates soyma g√∂revi aldƒ±n.", [
              { text: "Soy", action: () => { player.karma += 1; speakText("Patates soyma g√∂revi tamamlandƒ±."); } },
              { text: "ƒ∞tiraz et", action: () => { player.karma -= 5; showEvent("Ceza!", "Komutan ceza verdi.", [{ text: "T√ºh", action: () => { speakText("Komutan ceza verdi."); } }]); } }
            ]);
          } else if (randomEvent < 0.6) {
            showEvent("Askerlik Olayƒ±", "Sava≈üa katƒ±lmak zorunda kaldƒ±n!", [
              { text: "Cesurca sava≈ü", action: () => { player.karma += 15; showEvent("Kahramanlƒ±k!", "Takdir edildin.", [{ text: "Te≈üekk√ºrler", action: () => { speakText("Sava≈üta kahramanlƒ±k g√∂sterdin."); } }]); } },
              { text: "Saklan", action: () => { player.karma -= 10; showEvent("Korkaklƒ±k!", "Ceza aldƒ±n.", [{ text: "Eyvah", action: () => { speakText("Sava≈üta saklandƒ±n ve ceza aldƒ±n."); } }]); } }
            ]);
            document.getElementById("explosion").play();
          } else if (randomEvent < 0.8) {
            showEvent("Firar ≈ûansƒ±", "Firar etmek ister misin? √áok riskli!", [
              { text: "Firar et", action: () => { attemptDesertion(); speakText("Firar etmeyi deniyorsun."); } },
              { text: "Kƒ±≈ülada kal", action: () => { speakText("Kƒ±≈ülada kalmayƒ± tercih ettin."); } }
            ]);
          }
        }
      }
      updateInfo();
    }

    function attemptDesertion() {
      clearInterval(militaryInterval);
      militaryInfoDiv.style.display = "none";
      player.militaryStatus = "Firari";
      createCityScene();
      showEvent("Firar Ettin!", "Kƒ±≈üladan ka√ßtƒ±n! Polis seni arayacak...", [
        { text: "Saklanmaya √ßalƒ±≈ü", action: () => { player.karma -= 20; handleDesertionChase(); speakText("Firar ettin, ≈üimdi saklanmalƒ±sƒ±n."); } }
      ]);
      document.getElementById("carHorn").play();
    }

    function handleDesertionChase() {
      let chaseAttempts = 0;
      const chaseInterval = setInterval(() => {
        chaseAttempts++;
        if (chaseAttempts > 5) {
          clearInterval(chaseInterval);
          if (Math.random() < 0.7) {
            showEvent("Yakalandƒ±n!", "Polis seni yakaladƒ± ve askere geri g√∂t√ºr√ºyor!", [
              { text: "Lanet olsun", action: () => { startMilitaryService("normal"); player.militaryServiceRemaining += 180; player.karma -= 50; speakText("Yakalandƒ±n ve askerliƒüe geri d√∂nd√ºn."); } }
            ]);
          } else {
            showEvent("Ka√ßmayƒ± Ba≈üardƒ±n!", "Polisten ka√ßmayƒ± ba≈üardƒ±n! Artƒ±k √∂zg√ºrs√ºn ama firarisin.", [
              { text: "Yeni bir hayata ba≈üla", action: () => { speakText("Polisten ka√ßmayƒ± ba≈üardƒ±n."); } }
            ]);
            player.militaryStatus = "Firari (Ba≈üarƒ±lƒ±)";
            ageInterval = setInterval(() => {
              player.age++;
              updateInfo();
              handleLifeEvents();
            }, 5000);
          }
        } else {
          showEvent("Ka√ßƒ±≈ü Devam Ediyor...", `Polis seni aramaya devam ediyor. (${5 - chaseAttempts} deneme kaldƒ±)`, [
            { text: "K√∂≈üeye gizlen", action: () => { } },
            { text: "Kƒ±lƒ±k deƒüi≈ütir", action: () => { } }
          ]);
        }
      }, 5000);
    }

    // --- Relationship & Social Functions ---
    function attemptMarriage() {
      const partnerChance = Math.random();
      if (partnerChance < 0.6) {
        player.isMarried = true;
        showEvent("Evlendin!", "Hayat arkada≈üƒ±nƒ± buldun ve evlendiniz! Mutluluklar dileriz.", [
          { text: "√áok mutluyum!", action: () => { player.karma += 20; speakText("Evlendin!"); } }
        ]);
      } else {
        showEvent("Evlenemedin", "Uygun birini bulamadƒ±n veya evlilik kƒ±smetin olmadƒ±. Tekrar dene?", [
          { text: "≈ûansƒ±mƒ± denerim", action: () => { } },
          { text: "Yalnƒ±z kalacaƒüƒ±m", action: () => { player.karma -= 5; speakText("Evlenemedin."); } }
        ]);
      }
    }

    function goToHalƒ±saha() {
      if (player.money >= 50) {
        player.money -= 50;
        createHalƒ±sahaScene();
        showEvent("Halƒ±saha Ma√ßƒ±", "Arkada≈ülarƒ±nla harika bir ma√ß yaptƒ±n!", [
          { text: "√áok eƒülendim!", action: () => { player.psychologicalHealth += 10; player.karma += 3; speakText("Halƒ±saha ma√ßƒ± yaptƒ±n."); createCityScene(); } }
        ]);
      } else {
        showEvent("Yetersiz Para", "Halƒ±saha i√ßin yeterli paran yok! (50‚Ç∫)", [
          { text: "Pekala", action: () => { } }
        ]);
        speakText("Halƒ±saha i√ßin yeterli paran yok.");
      }
    }

    // --- Asset Functions ---
    function buyHouse() {
      if (player.money >= 5000) {
        player.money -= 5000;
        player.hasHouse = true;
        showEvent("Ev Aldƒ±n!", "Kendi evine sahip oldun! Artƒ±k kira derdin yok.", [
          { text: "Harika!", action: () => { player.karma += 10; speakText("Ev satƒ±n aldƒ±n!"); createHomeScene(); } }
        ]);
      } else {
        showEvent("Yetersiz Para", "Ev almak i√ßin yeterli paran yok! (5.000‚Ç∫)", [
          { text: "Daha √ßok √ßalƒ±≈ümalƒ±yƒ±m", action: () => { speakText("Ev almak i√ßin yeterli paran yok."); } }
        ]);
      }
    }

    function buyCar() {
      if (player.money >= 2000) {
        player.money -= 2000;
        player.hasCar = true;
        showEvent("Araba Aldƒ±n!", "Kendi araban var! Ula≈üƒ±m artƒ±k √ßok daha kolay.", [
          { text: "Yola √ßƒ±kalƒ±m!", action: () => { player.karma += 5; speakText("Araba satƒ±n aldƒ±n!"); } }
        ]);
      } else {
        showEvent("Yetersiz Para", "Araba almak i√ßin yeterli paran yok! (2.000‚Ç∫)", [
          { text: "Daha √ßok para biriktir", action: () => { speakText("Araba almak i√ßin yeterli paran yok."); } }
        ]);
      }
    }

    // --- Shop Functions ---
    function enterBuilding(buildingType) {
        if (buildingType === 'shop') {
            createShopScene();
            showShopOverlay();
        } else if (buildingType === 'hospital') {
            createHospitalScene();
            showEvent("Hastanedesin", "≈ûu an hastanede bulunuyorsun. Ne yapmak istersin?", [
                { text: "Doktorla konu≈ü (100‚Ç∫)", action: () => {
                    if (player.money >= 100) { player.money -= 100; speakText("Doktorla konu≈ütun. Kendini biraz daha iyi hissediyorsun."); player.psychologicalHealth = Math.min(100, player.psychologicalHealth + 10); createCityScene(); }
                    else { showEvent("Yetersiz Para", "Doktor √ºcreti i√ßin yeterli paran yok!", [{ text: "Pekala", action: () => { createCityScene(); } }]); }
                }},
                { text: "√áƒ±k", action: () => { createCityScene(); speakText("Hastaneden ayrƒ±ldƒ±n."); } }
            ]);
        } else if (buildingType === 'halƒ±saha') {
            goToHalƒ±saha(); // Reuse existing function
        }
    }

    function showShopOverlay() {
        shopOverlay.style.display = 'flex';
        shopMessage.innerText = "";
    }

    function hideShopOverlay() {
        shopOverlay.style.display = 'none';
        createCityScene(); // Return to city when leaving shop
    }

    function buyItem(item) {
        if (item === 'clothes') {
            if (player.money >= 200) {
                player.money -= 200;
                player.playerClothesColor = Math.floor(Math.random()*16777215); // Random new color
                updatePlayerAppearance();
                shopMessage.innerText = "Yeni kƒ±yafet aldƒ±n! Kalan para: " + player.money + "‚Ç∫";
                speakText("Yeni kƒ±yafet aldƒ±n!");
            } else {
                shopMessage.innerText = "Yeterli paran yok! Kƒ±yafet 200‚Ç∫.";
                speakText("Kƒ±yafet almak i√ßin yeterli paran yok!");
            }
        } else if (item === 'pants') {
            if (player.money >= 150) {
                player.money -= 150;
                player.playerPantsColor = Math.floor(Math.random()*16777215); // Random new color
                updatePlayerAppearance();
                shopMessage.innerText = "Yeni pantolon aldƒ±n! Kalan para: " + player.money + "‚Ç∫";
                speakText("Yeni pantolon aldƒ±n!");
            } else {
                shopMessage.innerText = "Yeterli paran yok! Pantolon 150‚Ç∫.";
                speakText("Pantolon almak i√ßin yeterli paran yok!");
            }
        }
        updateInfo();
    }


    // --- Crime Functions ---
    function handleRandomEvent() {
      const eventType = Math.random();

      if (eventType < 0.15) {
        showEvent("≈ûanslƒ± G√ºn!", "Yolda para buldun!", [
          { text: "Al", action: () => { player.money += 100; player.karma += 1; speakText("Yolda para buldun."); } },
          { text: "Karakola teslim et", action: () => { showEvent("D√ºr√ºstl√ºk!", "√áok d√ºr√ºst davrandƒ±n. Karma puanƒ±n arttƒ±!", [{ text: "G√∂rev tamam", action: () => { player.karma += 10; speakText("Parayƒ± karakola teslim ettin."); } }]); } }
        ]);
      } else if (eventType < 0.3) {
        showEvent("K√∂t√º Bir G√ºn", "Cebindeki paranƒ± √ßaldƒ±rdƒ±n!", [
          { text: "Lanet olsun!", action: () => { player.money = Math.max(0, player.money - 500); player.karma -= 2; speakText("Paran √ßalƒ±ndƒ±!"); } }
        ]);
      } else if (eventType < 0.45 && player.age >= 18) {
        showEvent("Kavga Fƒ±rsatƒ±!", "Bir grup gen√ßle aranda gerginlik var. Kavga etmek ister misin?", [
          { text: "Kavga Ba≈ülat", action: () => { startFight(); speakText("Kavga ba≈ülatƒ±yorsun!"); } },
          { text: "Uzakla≈ü", action: () => { showEvent("Uzakla≈ütƒ±n", "Problemlerden ka√ßtƒ±n.", [{ text: "ƒ∞yi fikir", action: () => { player.psychologicalHealth += 5; speakText("Kavgadan uzakla≈ütƒ±n."); } }]); } }
        ]);
      } else if (eventType < 0.6) {
        showEvent("Ahlaki ƒ∞kilem", "Bir arkada≈üƒ±n senden yasa dƒ±≈üƒ± bir i≈üe katƒ±lmanƒ± istiyor.", [
          { text: "Kabul et (Riskli ama kazan√ßlƒ±)", action: () => { attemptCrime(); speakText("Yasa dƒ±≈üƒ± i≈ü teklifini kabul ettin."); } },
          { text: "Reddet (G√ºvenli)", action: () => { player.karma += 5; showEvent("D√ºr√ºstl√ºk", "Arkada≈üƒ±nƒ± reddettin, doƒüru olanƒ± yaptƒ±n.", [{ text: "ƒ∞yi insan", action: () => { speakText("Yasa dƒ±≈üƒ± i≈üi reddettin."); } }]); } }
        ]);
      } else {
        showEvent("Sƒ±radan Bir G√ºn", "Yeni bir hobiye ba≈ülamak ister misin?", [
          { text: "Evet (100‚Ç∫)", action: () => { if (player.money >= 100) { player.money -= 100; player.karma += 3; speakText("Yeni bir hobiye ba≈üladƒ±n."); } else { showEvent("Yetersiz Para", "Yeterli paran yok!", [{text: "Pekala", action: () => {}}]); } } },
          { text: "Hayƒ±r", action: () => { } }
        ]);
      }
    }

    function startFight() {
        document.getElementById("fightSound").play();
        const outcome = Math.random();
        if (outcome < 0.4) {
            showEvent("Kavgayƒ± Kazandƒ±n!", "Rakiplerini yendin! Moralinde artƒ±≈ü var.", [
                { text: "Zafer!", action: () => { player.psychologicalHealth += 15; player.karma -= 5; speakText("Kavgayƒ± kazandƒ±n!"); } }
            ]);
        } else if (outcome < 0.8) {
            showEvent("Kavgayƒ± Kaybettin!", "Dayak yedin ve yaralandƒ±n. Saƒülƒ±ƒüƒ±n d√º≈üt√º.", [
                { text: "Acƒ± verici", action: () => { player.psychologicalHealth -= 20; player.karma -= 10; speakText("Kavgayƒ± kaybettin!"); } }
            ]);
            enterBuilding('hospital'); // Go to hospital automatically
        } else {
            showEvent("Berabere Kaldƒ±n!", "Kavga uzadƒ± ve sonu√ßsuz kaldƒ±. Yorgunsun.", [
                { text: "Neyse", action: () => { player.psychologicalHealth -= 5; speakText("Kavga berabere bitti."); } }
            ]);
        }
    }


    function attemptCrime() {
      const crimeType = Math.random();
      if (crimeType < 0.5) {
        showEvent("Banka Soygunu Planƒ±!", "Bir banka soygununa katƒ±lmak ister misin? Yakalanƒ±rsan hapishane...", [
          { text: "Evet, soy", action: () => { executeBankRobbery(); speakText("Banka soygunu planlƒ±yorsun."); } },
          { text: "Hayƒ±r, √ßok riskli", action: () => { player.karma += 1; } }
        ]);
      } else {
        showEvent("Araba √áalma Fƒ±rsatƒ±!", "Park edilmi≈ü l√ºks bir araba g√∂rd√ºn. √áalmak ister misin?", [
          { text: "Evet, √ßal", action: () => { executeCarTheft(); speakText("Araba √ßalmayƒ± deniyorsun."); } },
          { text: "Hayƒ±r, ba≈üƒ±m belaya girmesin", action: () => { player.karma += 1; } }
        ]);
      }
    }

    function executeBankRobbery() {
      const successChance = Math.random();
      if (successChance < 0.3) {
        const loot = Math.floor(Math.random() * 5000) + 1000;
        player.money += loot;
        player.karma -= 50;
        showEvent("Soygun Ba≈üarƒ±lƒ±!", `Bankayƒ± soydun ve ${loot}‚Ç∫ kazandƒ±n!`, [
          { text: "Zengin oldum!", action: () => { speakText(`Banka soygunu ba≈üarƒ±lƒ±, ${loot} lira kazandƒ±n.`); } }
        ]);
        document.getElementById("explosion").play();
      } else {
        player.karma -= 100;
        showEvent("Yakalandƒ±n!", "Banka soygununda yakalandƒ±n! Hapse giriyorsun.", [
          { text: "Hapishaneye git", action: () => { goToPrison(5); speakText("Banka soygununda yakalandƒ±n, hapse giriyorsun."); } }
        ]);
      }
    }

    function executeCarTheft() {
      const successChance = Math.random();
      if (successChance < 0.6) {
        player.hasCar = true;
        player.money += 500;
        player.karma -= 20;
        showEvent("Araba √áalƒ±ndƒ±!", "Araba senin oldu! Satabilir veya kullanabilirsin.", [
          { text: "S√ºper!", action: () => { speakText("Araba √ßalma ba≈üarƒ±lƒ±!"); } }
        ]);
        document.getElementById("carHorn").play();
      } else {
        player.karma -= 40;
        showEvent("Yakalandƒ±n!", "Araba √ßalarken yakalandƒ±n! Hapse giriyorsun.", [
          { text: "Hapishaneye git", action: () => { goToPrison(2); speakText("Araba √ßalarken yakalandƒ±n, hapse giriyorsun."); } }
        ]);
      }
    }

    function goToPrison(years) {
      clearInterval(ageInterval);
      showEvent("Hapishane!", `Hapishaneye girdin. ${years} yƒ±l hapis yatacaksƒ±n.`, [
        { text: "Zor zamanlar...", action: () => { speakText(`Hapishaneye girdin, ${years} yƒ±l hapis yatacaksƒ±n.`); } }
      ]);
      const prisonSentenceInterval = setInterval(() => {
        years--;
        showEvent("Hapishane...", `Hapishanede ${years} yƒ±lƒ±n kaldƒ±.`, [
          { text: "Bekle...", action: () => { } }
        ]);
        if (years <= 0) {
          clearInterval(prisonSentenceInterval);
          showEvent("√ñzg√ºrl√ºk!", "Hapisten √ßƒ±ktƒ±n! Yeni bir ba≈ülangƒ±√ß yapabilirsin.", [
            { text: "Hayata geri d√∂n", action: () => { speakText("Hapisten √ßƒ±ktƒ±n, √∂zg√ºrs√ºn!"); } }
          ]);
          ageInterval = setInterval(() => {
            player.age++;
            updateInfo();
            handleLifeEvents();
          }, 5000);
        }
      }, 5000);
    }

    // --- Psychologist Functions ---
    function goToPsychologist() {
      if (player.psychologistBanUntil > player.age) { // Compare with age directly
        showEvent("Psikolog Yasaƒüƒ±", `K√ºf√ºr ettiƒüin i√ßin ${player.psychologistBanUntil - player.age} ay daha psikologdan yardƒ±m alamazsƒ±n.`, [
          { text: "Anladƒ±m", action: () => { createCityScene(); } }
        ]);
        return;
      }
      if (player.money >= 200) {
        player.money -= 200;
        player.curseCount = 0; // Reset curse count for new session
        curseAttemptsSpan.innerText = 5; // Display max attempts
        psychologistInput.value = "";
        psychologistResponseDiv.innerText = "";
        psychologistOverlay.style.display = "flex";
        speakText("Merhaba, size nasƒ±l yardƒ±mcƒ± olabilirim? Dertlerinizi yazarak anlatabilirsiniz.", null);
        createHospitalScene(); // Set scene to hospital
      } else {
        showEvent("Yetersiz Para", "Psikolog √ºcreti i√ßin yeterli paran yok! (200‚Ç∫)", [
          { text: "Pekala", action: () => { createCityScene(); } }
        ]);
      }
    }

    function submitPsychologistInput() {
      const userText = psychologistInput.value.toLowerCase();
      const forbiddenWords = ["lan", "salak", "aptal", "mal", "geri zekalƒ±", "pi√ß", "siktir", "orospu", "yarak", "amk", "aq", "sg"];
      let hasCurse = false;

      for (const word of forbiddenWords) {
        if (userText.includes(word)) {
          hasCurse = true;
          break;
        }
      }

      if (hasCurse) {
        player.curseCount++;
        curseAttemptsSpan.innerText = 5 - player.curseCount;
        if (player.curseCount >= 5) {
          psychologistResponseDiv.innerText = "Yeter! Seni artƒ±k kabul edemem. 7 ay boyunca gelme!";
          speakText("Yeter! Seni artƒ±k kabul edemem. 7 ay boyunca gelme!");
          player.psychologistBanUntil = player.age + (7 / 12); // Ban for 7 months, convert to years for age comparison
          setTimeout(() => { hidePsychologistOverlay(); createCityScene(); }, 2000);
        } else {
          psychologistResponseDiv.innerText = `L√ºtfen k√ºf√ºr etmeyiniz. (${5 - player.curseCount} hakkƒ±nƒ±z kaldƒ±.)`;
          speakText("L√ºtfen k√ºf√ºr etmeyiniz.");
        }
      } else {
        // Simple response based on keywords
        if (userText.includes("mutsuzum") || userText.includes("depresyon")) {
          psychologistResponseDiv.innerText = "Anlƒ±yorum, bu zor bir durum. Daha iyi hissetmen i√ßin sana yardƒ±mcƒ± olacaƒüƒ±m. K√º√ß√ºk adƒ±mlarla ba≈ülayabiliriz.";
          player.psychologicalHealth = Math.min(100, player.psychologicalHealth + 10);
          speakText("Anlƒ±yorum, bu zor bir durum. Daha iyi hissetmen i√ßin sana yardƒ±mcƒ± olacaƒüƒ±m. K√º√ß√ºk adƒ±mlarla ba≈ülayabiliriz.");
        } else if (userText.includes("stres") || userText.includes("kaygƒ±")) {
          psychologistResponseDiv.innerText = "Stres ve kaygƒ± ya≈üamƒ±n bir par√ßasƒ± olabilir, ancak bunlarla ba≈üa √ßƒ±kma y√∂ntemleri geli≈ütirebiliriz.";
          player.psychologicalHealth = Math.min(100, player.psychologicalHealth + 5);
          speakText("Stres ve kaygƒ± ya≈üamƒ±n bir par√ßasƒ± olabilir, ancak bunlarla ba≈üa √ßƒ±kma y√∂ntemleri geli≈ütirebiliriz.");
        } else if (userText.includes("arkada≈ü")) {
            psychologistResponseDiv.innerText = "Arkada≈ülƒ±k ili≈ükileri √∂nemlidir. Onlarla baƒülarƒ±nƒ± g√º√ßlendirmek i√ßin neler yapabilirsin?";
            speakText("Arkada≈ülƒ±k ili≈ükileri √∂nemlidir. Onlarla baƒülarƒ±nƒ± g√º√ßlendirmek i√ßin neler yapabilirsin?");
        } else if (userText.includes("i≈ü")) {
            psychologistResponseDiv.innerText = "ƒ∞≈ü hayatƒ±ndaki zorluklar moralini bozmu≈ü olabilir. Bu konuda ne gibi adƒ±mlar atabiliriz?";
            speakText("ƒ∞≈ü hayatƒ±ndaki zorluklar moralini bozmu≈ü olabilir. Bu konuda ne gibi adƒ±mlar atabiliriz?");
        }
        else {
          psychologistResponseDiv.innerText = "Anlƒ±yorum. Biraz daha a√ßmak ister misin?";
          speakText("Anlƒ±yorum. Biraz daha a√ßmak ister misin?");
        }
      }
    }

    function hidePsychologistOverlay() {
      psychologistOverlay.style.display = "none";
      createCityScene(); // Return to city scene
    }


    // --- Game Controls (Joystick-like) ---
    // Keyboard listener for WASD movement
    document.addEventListener('keydown', (event) => {
        if (event.key === 'w' || event.key === 'W') movePlayer('forward');
        if (event.key === 's' || event.key === 'S') movePlayer('back');
        if (event.key === 'a' || event.key === 'A') movePlayer('left');
        if (event.key === 'd' || event.key === 'D') movePlayer('right');
    });
    // Stop animation when key is released (simplified for this example)
    document.addEventListener('keyup', (event) => {
        if (event.key === 'w' || event.key === 'W' || event.key === 's' || event.key === 'S') {
            isWalking = false;
            isRunning = false;
        }
    });

    function movePlayer(direction) {
      const rotationSpeed = 0.05;
      let moveSpeed = 0.1; // Base speed

      if (!playerObject) return;

      if (isRunning) moveSpeed = 0.2; // Increase speed if running

      switch (direction) {
        case 'forward':
          playerObject.position.x += Math.sin(playerObject.rotation.y) * moveSpeed;
          playerObject.position.z += Math.cos(playerObject.rotation.y) * moveSpeed;
          break;
        case 'back':
          playerObject.position.x -= Math.sin(playerObject.rotation.y) * moveSpeed;
          playerObject.position.z -= Math.cos(playerObject.rotation.y) * moveSpeed;
          break;
        case 'left':
          playerObject.rotation.y += rotationSpeed;
          break;
        case 'right':
          playerObject.rotation.y -= rotationSpeed;
          break;
      }
      isWalking = true; // Any movement sets to walking
    }

    function toggleWalkAnimation() {
      isWalking = !isWalking;
      isRunning = false; // Cannot walk and run at same time
      // For GLTF models:
      // if (mixerPlayer) {
      //   const walkClip = mixerPlayer.clipAction(playerObject.animations.find(a => a.name === 'walk'));
      //   if (isWalking) { walkClip.play(); } else { walkClip.stop(); }
      // }
    }

    function toggleRunAnimation() {
      isRunning = !isRunning;
      isWalking = false; // Cannot walk and run at same time
      // For GLTF models:
      // if (mixerPlayer) {
      //   const runClip = mixerPlayer.clipAction(playerObject.animations.find(a => a.name === 'run'));
      //   if (isRunning) { runClip.play(); } else { runClip.stop(); }
      // }
    }

    function endGame() {
      clearInterval(ageInterval);
      if (militaryInterval) clearInterval(militaryInterval);
      hideEvent();
      psychologistOverlay.style.display = 'none';
      shopOverlay.style.display = 'none';

      document.getElementById("ui").style.display = "flex";
      document.getElementById("ui").innerHTML = `
        <h1>Hayat Yolculuƒüunun Sonu</h1>
        <p>**${player.name} ${player.surname}**, ${player.age} ya≈üƒ±nda hayatƒ±nƒ± kaybetti.</p>
        <p>Hayatƒ±nda topladƒ±ƒüƒ±n **Karma puanƒ±**: ${player.karma}</p>
        <p>Kalan Para: **${player.money}‚Ç∫**</p>
        <p>**Eƒüitim Seviyesi**: ${player.educationLevel}</p>
        <p>**Meslek**: ${player.job}</p>
        <p>${player.karma >= 0 ? "G√ºzel bir hayat ya≈üadƒ±n, ardƒ±nda iyi anƒ±lar bƒ±raktƒ±n." : "Hayatƒ±nda bazƒ± zorlu se√ßimler yaptƒ±n, ancak her deneyim bir derstir."}</p>
        <button onclick="location.reload()">Tekrar Dene</button>
      `;
      scene.clear();
      renderer.setClearColor(0x000000);
      info.style.display = 'none';
      militaryInfoDiv.style.display = 'none';
      gameControls.style.display = 'none';
    }


    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
